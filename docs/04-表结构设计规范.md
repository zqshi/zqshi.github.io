# 数字员工系统表结构设计规范
## Digital Employee System Table Structure Design Standards v1.0

### 📋 文档信息
- **文档版本**: v1.0
- **创建日期**: 2024-01-24
- **适用范围**: 数字员工系统所有数据表设计
- **维护部门**: 数据建模组

---

## 🏗️ 表结构设计原则

### 1.1 基础设计原则

#### 1.1.1 表命名规范

| 命名类型 | 规范 | 示例 | 说明 |
|---------|------|------|------|
| **表名** | 复数形式，下划线分隔 | `users`, `agent_tasks` | 表示数据集合 |
| **主键** | 表名单数_id | `user_id`, `agent_id` | 统一主键命名 |
| **外键** | 引用表单数_id | `created_by`, `assigned_agent` | 清晰引用关系 |
| **索引** | idx_表名_字段名 | `idx_users_email` | 便于管理维护 |
| **约束** | ck_表名_约束描述 | `ck_tasks_status` | 描述约束用途 |

#### 1.1.2 表结构标准

```sql
-- 标准表结构模板
CREATE TABLE table_name (
    -- 1. 主键 (必须)
    table_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    
    -- 2. 业务字段 (按重要性排序)
    business_field_1 VARCHAR(100) NOT NULL,
    business_field_2 TEXT,
    business_field_3 JSONB DEFAULT '{}',
    
    -- 3. 状态字段 (如需要)
    status VARCHAR(20) NOT NULL DEFAULT 'active',
    
    -- 4. 审计字段 (标准)
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    created_by UUID,
    updated_by UUID,
    
    -- 5. 软删除字段 (如需要)
    deleted_at TIMESTAMP NULL,
    deleted_by UUID,
    
    -- 6. 版本控制字段 (如需要)
    version INTEGER NOT NULL DEFAULT 1,
    
    -- 7. 约束定义
    CONSTRAINT ck_table_status CHECK (status IN ('active', 'inactive', 'deleted')),
    CONSTRAINT fk_table_created_by FOREIGN KEY (created_by) REFERENCES users(user_id),
    CONSTRAINT fk_table_updated_by FOREIGN KEY (updated_by) REFERENCES users(user_id)
);

-- 8. 标准索引
CREATE INDEX idx_table_status ON table_name(status);
CREATE INDEX idx_table_created_at ON table_name(created_at);
CREATE INDEX idx_table_created_by ON table_name(created_by);

-- 9. 更新时间触发器
CREATE TRIGGER trigger_table_updated_at
    BEFORE UPDATE ON table_name
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();

-- 10. 表注释
COMMENT ON TABLE table_name IS '表功能描述';
COMMENT ON COLUMN table_name.business_field_1 IS '业务字段1描述';
```

### 1.2 字段设计标准

#### 1.2.1 必需字段规范

| 字段类型 | 字段名 | 数据类型 | 约束 | 说明 |
|---------|--------|----------|------|------|
| **主键** | {table}_id | UUID | PRIMARY KEY | 全局唯一标识 |
| **创建时间** | created_at | TIMESTAMP | NOT NULL | 记录创建时间 |
| **更新时间** | updated_at | TIMESTAMP | NOT NULL | 记录最后更新时间 |
| **创建人** | created_by | UUID | 外键引用users | 记录创建者 |
| **更新人** | updated_by | UUID | 外键引用users | 记录最后更新者 |

#### 1.2.2 可选字段规范

| 字段类型 | 字段名 | 数据类型 | 默认值 | 说明 |
|---------|--------|----------|--------|------|
| **状态字段** | status | VARCHAR(20) | 'active' | 记录状态 |
| **软删除** | deleted_at | TIMESTAMP | NULL | 软删除时间 |
| **删除人** | deleted_by | UUID | NULL | 软删除操作者 |
| **版本号** | version | INTEGER | 1 | 乐观锁版本控制 |
| **排序** | sort_order | INTEGER | 0 | 显示排序 |
| **备注** | remark | TEXT | NULL | 附加说明 |

---

## 📊 核心业务表设计

### 2.1 用户管理域表结构

#### 2.1.1 用户表 (users)

```sql
-- 用户基础信息表
CREATE TABLE users (
    -- 主键
    user_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    
    -- 基础信息
    username VARCHAR(50) UNIQUE NOT NULL,
    email_hash VARCHAR(64) UNIQUE NOT NULL,  -- 邮箱哈希(用于查询)
    email_encrypted BYTEA NOT NULL,          -- 加密邮箱
    phone_hash VARCHAR(64),                  -- 手机号哈希
    phone_encrypted BYTEA,                   -- 加密手机号
    password_hash VARCHAR(255) NOT NULL,     -- 密码哈希
    
    -- 用户属性
    display_name VARCHAR(100) NOT NULL,
    avatar_url VARCHAR(500),
    timezone VARCHAR(50) DEFAULT 'UTC',
    locale VARCHAR(10) DEFAULT 'zh-CN',
    
    -- 状态信息
    status VARCHAR(20) NOT NULL DEFAULT 'active',
    is_verified BOOLEAN NOT NULL DEFAULT false,
    email_verified_at TIMESTAMP,
    last_login_at TIMESTAMP,
    last_login_ip INET,
    
    -- 安全设置
    mfa_enabled BOOLEAN NOT NULL DEFAULT false,
    mfa_secret VARCHAR(32),
    failed_login_attempts INTEGER NOT NULL DEFAULT 0,
    locked_until TIMESTAMP,
    
    -- 审计字段
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    created_by UUID,
    updated_by UUID,
    
    -- 软删除
    deleted_at TIMESTAMP,
    deleted_by UUID,
    
    -- 约束
    CONSTRAINT ck_users_status CHECK (status IN ('active', 'inactive', 'suspended', 'deleted')),
    CONSTRAINT ck_users_email_format CHECK (email_hash ~ '^[a-f0-9]{64}$'),
    CONSTRAINT ck_users_failed_attempts CHECK (failed_login_attempts >= 0),
    CONSTRAINT fk_users_created_by FOREIGN KEY (created_by) REFERENCES users(user_id),
    CONSTRAINT fk_users_updated_by FOREIGN KEY (updated_by) REFERENCES users(user_id)
);

-- 索引
CREATE INDEX idx_users_username ON users(username);
CREATE INDEX idx_users_email_hash ON users(email_hash);
CREATE INDEX idx_users_phone_hash ON users(phone_hash);
CREATE INDEX idx_users_status ON users(status);
CREATE INDEX idx_users_created_at ON users(created_at);
CREATE INDEX idx_users_last_login ON users(last_login_at);
CREATE UNIQUE INDEX idx_users_active_username ON users(username) WHERE deleted_at IS NULL;

-- 触发器
CREATE TRIGGER trigger_users_updated_at
    BEFORE UPDATE ON users
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();

-- 注释
COMMENT ON TABLE users IS '用户基础信息表';
COMMENT ON COLUMN users.email_hash IS '邮箱SHA256哈希值，用于查询';
COMMENT ON COLUMN users.email_encrypted IS '加密存储的邮箱地址';
COMMENT ON COLUMN users.mfa_enabled IS '是否启用多因子认证';
COMMENT ON COLUMN users.failed_login_attempts IS '连续登录失败次数';
```

#### 2.1.2 用户角色表 (user_roles)

```sql
-- 用户角色关系表
CREATE TABLE user_roles (
    -- 主键
    assignment_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    
    -- 关联字段
    user_id UUID NOT NULL,
    role_id UUID NOT NULL,
    
    -- 角色属性
    granted_by UUID NOT NULL,
    granted_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    expires_at TIMESTAMP,  -- 角色过期时间
    
    -- 状态
    is_active BOOLEAN NOT NULL DEFAULT true,
    
    -- 审计字段
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    created_by UUID,
    updated_by UUID,
    
    -- 外键约束
    CONSTRAINT fk_user_roles_user FOREIGN KEY (user_id) REFERENCES users(user_id) ON DELETE CASCADE,
    CONSTRAINT fk_user_roles_role FOREIGN KEY (role_id) REFERENCES roles(role_id) ON DELETE CASCADE,
    CONSTRAINT fk_user_roles_granted_by FOREIGN KEY (granted_by) REFERENCES users(user_id),
    
    -- 唯一约束
    CONSTRAINT uk_user_roles_active UNIQUE (user_id, role_id, is_active)
);

-- 索引
CREATE INDEX idx_user_roles_user_id ON user_roles(user_id);
CREATE INDEX idx_user_roles_role_id ON user_roles(role_id);
CREATE INDEX idx_user_roles_expires_at ON user_roles(expires_at);
CREATE INDEX idx_user_roles_active ON user_roles(is_active, expires_at);

-- 注释
COMMENT ON TABLE user_roles IS '用户角色关系表';
COMMENT ON COLUMN user_roles.expires_at IS '角色过期时间，NULL表示永不过期';
```

### 2.2 Agent管理域表结构

#### 2.2.1 Agent主表 (agents)

```sql
-- Agent基础信息表
CREATE TABLE agents (
    -- 主键
    agent_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    
    -- 基础信息
    agent_type VARCHAR(50) NOT NULL,
    agent_name VARCHAR(100) NOT NULL,
    version VARCHAR(20) NOT NULL DEFAULT '1.0.0',
    description TEXT,
    
    -- 配置信息
    config JSONB NOT NULL DEFAULT '{}',
    capabilities JSONB NOT NULL DEFAULT '[]',
    constraints JSONB NOT NULL DEFAULT '{}',
    
    -- 运行状态
    status VARCHAR(20) NOT NULL DEFAULT 'inactive',
    health_status VARCHAR(20) NOT NULL DEFAULT 'unknown',
    last_heartbeat TIMESTAMP,
    
    -- 性能设置
    max_concurrent_tasks INTEGER NOT NULL DEFAULT 10,
    timeout_seconds INTEGER NOT NULL DEFAULT 300,
    priority_level INTEGER NOT NULL DEFAULT 5,
    
    -- 资源限制
    memory_limit_mb INTEGER DEFAULT 512,
    cpu_limit_cores DECIMAL(3,2) DEFAULT 0.5,
    
    -- 统计信息
    total_tasks_executed INTEGER NOT NULL DEFAULT 0,
    successful_tasks INTEGER NOT NULL DEFAULT 0,
    failed_tasks INTEGER NOT NULL DEFAULT 0,
    average_execution_time DECIMAL(10,3) DEFAULT 0,
    
    -- 审计字段
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    created_by UUID NOT NULL,
    updated_by UUID,
    
    -- 软删除
    deleted_at TIMESTAMP,
    deleted_by UUID,
    
    -- 版本控制
    version_number INTEGER NOT NULL DEFAULT 1,
    
    -- 约束
    CONSTRAINT ck_agents_status CHECK (status IN ('active', 'inactive', 'suspended', 'maintenance', 'deleted')),
    CONSTRAINT ck_agents_health CHECK (health_status IN ('healthy', 'degraded', 'unhealthy', 'unknown')),
    CONSTRAINT ck_agents_priority CHECK (priority_level BETWEEN 1 AND 10),
    CONSTRAINT ck_agents_max_tasks CHECK (max_concurrent_tasks > 0),
    CONSTRAINT ck_agents_timeout CHECK (timeout_seconds > 0),
    CONSTRAINT ck_agents_memory CHECK (memory_limit_mb > 0),
    CONSTRAINT ck_agents_cpu CHECK (cpu_limit_cores > 0),
    CONSTRAINT ck_agents_config_structure CHECK (jsonb_typeof(config) = 'object'),
    CONSTRAINT ck_agents_capabilities_structure CHECK (jsonb_typeof(capabilities) = 'array'),
    
    -- 外键
    CONSTRAINT fk_agents_created_by FOREIGN KEY (created_by) REFERENCES users(user_id),
    CONSTRAINT fk_agents_updated_by FOREIGN KEY (updated_by) REFERENCES users(user_id),
    
    -- 唯一约束
    CONSTRAINT uk_agents_type_version UNIQUE (agent_type, version, deleted_at)
);

-- 索引
CREATE INDEX idx_agents_type ON agents(agent_type);
CREATE INDEX idx_agents_status ON agents(status);
CREATE INDEX idx_agents_health_status ON agents(health_status);
CREATE INDEX idx_agents_created_by ON agents(created_by);
CREATE INDEX idx_agents_created_at ON agents(created_at);
CREATE INDEX idx_agents_last_heartbeat ON agents(last_heartbeat);
CREATE INDEX idx_agents_priority ON agents(priority_level);

-- GIN索引用于JSONB字段
CREATE INDEX idx_agents_config_gin ON agents USING GIN (config);
CREATE INDEX idx_agents_capabilities_gin ON agents USING GIN (capabilities);

-- 复合索引
CREATE INDEX idx_agents_active_status ON agents(status, health_status) WHERE deleted_at IS NULL;
CREATE INDEX idx_agents_performance ON agents(agent_type, successful_tasks, average_execution_time);

-- 触发器
CREATE TRIGGER trigger_agents_updated_at
    BEFORE UPDATE ON agents
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();

-- 统计信息更新触发器
CREATE OR REPLACE FUNCTION update_agent_statistics()
RETURNS TRIGGER AS $$
BEGIN
    -- 更新版本号(乐观锁)
    NEW.version_number = OLD.version_number + 1;
    
    -- 重新计算平均执行时间
    IF NEW.total_tasks_executed > 0 THEN
        NEW.average_execution_time = (
            OLD.average_execution_time * OLD.total_tasks_executed + 
            COALESCE(NEW.average_execution_time, 0)
        ) / NEW.total_tasks_executed;
    END IF;
    
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trigger_agents_statistics
    BEFORE UPDATE ON agents
    FOR EACH ROW
    EXECUTE FUNCTION update_agent_statistics();

-- 注释
COMMENT ON TABLE agents IS 'Agent基础信息和配置表';
COMMENT ON COLUMN agents.config IS 'Agent配置信息，JSON格式';
COMMENT ON COLUMN agents.capabilities IS 'Agent能力列表，JSON数组格式';
COMMENT ON COLUMN agents.constraints IS 'Agent约束条件，JSON格式';
COMMENT ON COLUMN agents.health_status IS 'Agent健康状态';
COMMENT ON COLUMN agents.version_number IS '版本号，用于乐观锁控制';
```

#### 2.2.2 Agent能力表 (agent_capabilities)

```sql
-- Agent能力定义表
CREATE TABLE agent_capabilities (
    -- 主键
    capability_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    
    -- 基础信息
    capability_name VARCHAR(100) NOT NULL,
    capability_type VARCHAR(50) NOT NULL,
    description TEXT,
    
    -- 能力属性
    skill_level INTEGER NOT NULL DEFAULT 5,
    tools_required JSONB DEFAULT '[]',
    prerequisites JSONB DEFAULT '[]',
    
    -- 状态
    is_active BOOLEAN NOT NULL DEFAULT true,
    
    -- 审计字段
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    created_by UUID NOT NULL,
    updated_by UUID,
    
    -- 约束
    CONSTRAINT ck_agent_capabilities_skill_level CHECK (skill_level BETWEEN 1 AND 10),
    CONSTRAINT ck_agent_capabilities_tools_structure CHECK (jsonb_typeof(tools_required) = 'array'),
    CONSTRAINT fk_agent_capabilities_created_by FOREIGN KEY (created_by) REFERENCES users(user_id),
    
    -- 唯一约束
    CONSTRAINT uk_agent_capabilities_name UNIQUE (capability_name)
);

-- 索引
CREATE INDEX idx_agent_capabilities_type ON agent_capabilities(capability_type);
CREATE INDEX idx_agent_capabilities_skill_level ON agent_capabilities(skill_level);
CREATE INDEX idx_agent_capabilities_active ON agent_capabilities(is_active);

-- 注释
COMMENT ON TABLE agent_capabilities IS 'Agent能力定义表';
COMMENT ON COLUMN agent_capabilities.skill_level IS '能力等级，1-10级';
```

### 2.3 任务管理域表结构

#### 2.3.1 任务主表 (tasks)

```sql
-- 任务主表
CREATE TABLE tasks (
    -- 主键
    task_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    
    -- 基础信息
    task_type VARCHAR(50) NOT NULL,
    task_name VARCHAR(200),
    description TEXT,
    
    -- 任务数据
    input_data JSONB NOT NULL DEFAULT '{}',
    output_data JSONB,
    context_data JSONB DEFAULT '{}',
    
    -- 优先级和调度
    priority VARCHAR(20) NOT NULL DEFAULT 'normal',
    priority_score INTEGER NOT NULL DEFAULT 5,
    scheduled_at TIMESTAMP,
    deadline TIMESTAMP,
    
    -- 状态信息
    status VARCHAR(20) NOT NULL DEFAULT 'pending',
    previous_status VARCHAR(20),
    status_changed_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    -- 分配信息
    assigned_agent UUID,
    assigned_at TIMESTAMP,
    assigned_by UUID,
    
    -- 执行信息
    started_at TIMESTAMP,
    completed_at TIMESTAMP,
    execution_time DECIMAL(10,3),
    retry_count INTEGER NOT NULL DEFAULT 0,
    max_retries INTEGER NOT NULL DEFAULT 3,
    
    -- 结果信息
    result_status VARCHAR(20),
    error_message TEXT,
    error_code VARCHAR(50),
    confidence_score DECIMAL(3,2),
    
    -- 依赖关系
    parent_task_id UUID,
    depends_on JSONB DEFAULT '[]',  -- 依赖的任务ID列表
    
    -- 审计字段
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    created_by UUID NOT NULL,
    updated_by UUID,
    
    -- 约束
    CONSTRAINT ck_tasks_status CHECK (status IN (
        'pending', 'queued', 'assigned', 'running', 
        'completed', 'failed', 'cancelled', 'timeout'
    )),
    CONSTRAINT ck_tasks_priority CHECK (priority IN ('low', 'normal', 'high', 'urgent', 'critical')),
    CONSTRAINT ck_tasks_priority_score CHECK (priority_score BETWEEN 1 AND 10),
    CONSTRAINT ck_tasks_retry_count CHECK (retry_count >= 0),
    CONSTRAINT ck_tasks_max_retries CHECK (max_retries >= 0),
    CONSTRAINT ck_tasks_confidence_score CHECK (confidence_score BETWEEN 0.0 AND 1.0),
    CONSTRAINT ck_tasks_execution_time CHECK (execution_time >= 0),
    CONSTRAINT ck_tasks_depends_structure CHECK (jsonb_typeof(depends_on) = 'array'),
    
    -- 外键
    CONSTRAINT fk_tasks_assigned_agent FOREIGN KEY (assigned_agent) REFERENCES agents(agent_id),
    CONSTRAINT fk_tasks_assigned_by FOREIGN KEY (assigned_by) REFERENCES users(user_id),
    CONSTRAINT fk_tasks_created_by FOREIGN KEY (created_by) REFERENCES users(user_id),
    CONSTRAINT fk_tasks_parent_task FOREIGN KEY (parent_task_id) REFERENCES tasks(task_id)
);

-- 主要索引
CREATE INDEX idx_tasks_status ON tasks(status);
CREATE INDEX idx_tasks_priority ON tasks(priority, priority_score);
CREATE INDEX idx_tasks_assigned_agent ON tasks(assigned_agent);
CREATE INDEX idx_tasks_task_type ON tasks(task_type);
CREATE INDEX idx_tasks_created_at ON tasks(created_at);
CREATE INDEX idx_tasks_scheduled_at ON tasks(scheduled_at);
CREATE INDEX idx_tasks_deadline ON tasks(deadline);
CREATE INDEX idx_tasks_parent_task ON tasks(parent_task_id);

-- 复合索引
CREATE INDEX idx_tasks_queue ON tasks(status, priority_score, created_at) 
    WHERE status IN ('pending', 'queued');
CREATE INDEX idx_tasks_agent_active ON tasks(assigned_agent, status, assigned_at)
    WHERE status IN ('assigned', 'running');
CREATE INDEX idx_tasks_completion ON tasks(status, completed_at)
    WHERE status IN ('completed', 'failed');

-- GIN索引
CREATE INDEX idx_tasks_input_data_gin ON tasks USING GIN (input_data);
CREATE INDEX idx_tasks_depends_on_gin ON tasks USING GIN (depends_on);

-- 分区索引(按创建时间)
CREATE INDEX idx_tasks_created_at_status ON tasks(created_at, status);

-- 触发器
CREATE TRIGGER trigger_tasks_updated_at
    BEFORE UPDATE ON tasks
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();

-- 状态变更记录触发器
CREATE OR REPLACE FUNCTION record_task_status_change()
RETURNS TRIGGER AS $$
BEGIN
    IF OLD.status IS DISTINCT FROM NEW.status THEN
        NEW.previous_status = OLD.status;
        NEW.status_changed_at = CURRENT_TIMESTAMP;
        
        -- 记录状态变更历史
        INSERT INTO task_status_history (
            task_id, old_status, new_status, changed_at, changed_by
        ) VALUES (
            NEW.task_id, OLD.status, NEW.status, CURRENT_TIMESTAMP, NEW.updated_by
        );
    END IF;
    
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trigger_tasks_status_change
    BEFORE UPDATE ON tasks
    FOR EACH ROW
    EXECUTE FUNCTION record_task_status_change();

-- 注释
COMMENT ON TABLE tasks IS '任务主表，存储所有任务信息';
COMMENT ON COLUMN tasks.input_data IS '任务输入数据，JSON格式';
COMMENT ON COLUMN tasks.depends_on IS '依赖的任务ID列表，JSON数组格式';
COMMENT ON COLUMN tasks.confidence_score IS '任务完成置信度，0.0-1.0';
```

#### 2.3.2 任务执行记录表 (task_executions)

```sql
-- 任务执行记录表(按月分区)
CREATE TABLE task_executions (
    -- 主键
    execution_id UUID DEFAULT uuid_generate_v4(),
    task_id UUID NOT NULL,
    agent_id UUID NOT NULL,
    
    -- 执行信息
    execution_sequence INTEGER NOT NULL DEFAULT 1,
    started_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    completed_at TIMESTAMP,
    execution_time DECIMAL(10,3),
    
    -- 状态信息
    status VARCHAR(20) NOT NULL DEFAULT 'running',
    result_status VARCHAR(20),
    error_message TEXT,
    error_stack_trace TEXT,
    
    -- 资源使用
    memory_usage_mb INTEGER,
    cpu_usage_percent DECIMAL(5,2),
    
    -- 性能指标
    input_tokens INTEGER,
    output_tokens INTEGER,
    api_calls_count INTEGER DEFAULT 0,
    
    -- 结果数据
    output_data JSONB,
    metadata JSONB DEFAULT '{}',
    
    -- 审计字段(简化)
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    
    -- 主键约束(包含分区键)
    PRIMARY KEY (execution_id, created_at),
    
    -- 外键约束
    CONSTRAINT fk_task_executions_task FOREIGN KEY (task_id) REFERENCES tasks(task_id),
    CONSTRAINT fk_task_executions_agent FOREIGN KEY (agent_id) REFERENCES agents(agent_id),
    
    -- 检查约束
    CONSTRAINT ck_task_executions_status CHECK (status IN (
        'running', 'completed', 'failed', 'timeout', 'cancelled'
    )),
    CONSTRAINT ck_task_executions_execution_time CHECK (execution_time >= 0),
    CONSTRAINT ck_task_executions_memory CHECK (memory_usage_mb >= 0),
    CONSTRAINT ck_task_executions_cpu CHECK (cpu_usage_percent >= 0 AND cpu_usage_percent <= 100),
    CONSTRAINT ck_task_executions_sequence CHECK (execution_sequence > 0)
    
) PARTITION BY RANGE (created_at);

-- 创建分区表(示例：2024年各月)
CREATE TABLE task_executions_2024_01 PARTITION OF task_executions
    FOR VALUES FROM ('2024-01-01') TO ('2024-02-01');
CREATE TABLE task_executions_2024_02 PARTITION OF task_executions
    FOR VALUES FROM ('2024-02-01') TO ('2024-03-01');
-- ... 其他月份分区

-- 分区表索引
CREATE INDEX idx_task_executions_2024_01_task_id ON task_executions_2024_01(task_id);
CREATE INDEX idx_task_executions_2024_01_agent_id ON task_executions_2024_01(agent_id);
CREATE INDEX idx_task_executions_2024_01_status ON task_executions_2024_01(status);

-- 全局索引
CREATE INDEX idx_task_executions_task_id ON task_executions(task_id, created_at);
CREATE INDEX idx_task_executions_agent_id ON task_executions(agent_id, created_at);
CREATE INDEX idx_task_executions_status ON task_executions(status, created_at);

-- 自动创建分区函数
CREATE OR REPLACE FUNCTION create_task_execution_partition(start_date DATE)
RETURNS void AS $$
DECLARE
    partition_name TEXT;
    end_date DATE;
BEGIN
    partition_name := 'task_executions_' || to_char(start_date, 'YYYY_MM');
    end_date := start_date + INTERVAL '1 month';
    
    EXECUTE format('CREATE TABLE %I PARTITION OF task_executions FOR VALUES FROM (%L) TO (%L)',
                   partition_name, start_date, end_date);
    
    -- 创建分区表索引
    EXECUTE format('CREATE INDEX %I ON %I (task_id)', 
                   'idx_' || partition_name || '_task_id', partition_name);
    EXECUTE format('CREATE INDEX %I ON %I (agent_id)', 
                   'idx_' || partition_name || '_agent_id', partition_name);
    EXECUTE format('CREATE INDEX %I ON %I (status)', 
                   'idx_' || partition_name || '_status', partition_name);
END;
$$ LANGUAGE plpgsql;

-- 注释
COMMENT ON TABLE task_executions IS '任务执行记录表，按月分区存储';
COMMENT ON COLUMN task_executions.execution_sequence IS '同一任务的执行序号，支持重试';
```

### 2.4 Prompt管理域表结构

#### 2.4.1 Prompt模板表 (prompt_templates)

```sql
-- Prompt模板主表
CREATE TABLE prompt_templates (
    -- 主键
    template_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    
    -- 基础信息
    template_name VARCHAR(100) NOT NULL,
    template_type VARCHAR(50) NOT NULL,
    agent_type VARCHAR(50),
    task_type VARCHAR(50),
    
    -- 版本信息
    version VARCHAR(20) NOT NULL DEFAULT '1.0.0',
    is_active BOOLEAN NOT NULL DEFAULT true,
    is_published BOOLEAN NOT NULL DEFAULT false,
    
    -- 模板内容
    template_content TEXT NOT NULL,
    template_variables JSONB DEFAULT '{}',
    validation_rules JSONB DEFAULT '{}',
    
    -- 分类标签
    category VARCHAR(50),
    tags JSONB DEFAULT '[]',
    
    -- 使用统计
    usage_count INTEGER NOT NULL DEFAULT 0,
    success_rate DECIMAL(5,2) DEFAULT 0,
    average_rating DECIMAL(3,2) DEFAULT 0,
    
    -- 配置信息
    max_tokens INTEGER,
    temperature DECIMAL(3,2),
    top_p DECIMAL(3,2),
    
    -- 审计字段
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    created_by UUID NOT NULL,
    updated_by UUID,
    published_at TIMESTAMP,
    published_by UUID,
    
    -- 软删除
    deleted_at TIMESTAMP,
    deleted_by UUID,
    
    -- 约束
    CONSTRAINT ck_prompt_templates_version CHECK (version ~ '^[0-9]+\.[0-9]+\.[0-9]+'),
    CONSTRAINT ck_prompt_templates_success_rate CHECK (success_rate >= 0 AND success_rate <= 100),
    CONSTRAINT ck_prompt_templates_rating CHECK (average_rating >= 0 AND average_rating <= 5),
    CONSTRAINT ck_prompt_templates_temperature CHECK (temperature >= 0 AND temperature <= 2),
    CONSTRAINT ck_prompt_templates_top_p CHECK (top_p >= 0 AND top_p <= 1),
    CONSTRAINT ck_prompt_templates_variables_structure CHECK (jsonb_typeof(template_variables) = 'object'),
    CONSTRAINT ck_prompt_templates_tags_structure CHECK (jsonb_typeof(tags) = 'array'),
    
    -- 外键
    CONSTRAINT fk_prompt_templates_created_by FOREIGN KEY (created_by) REFERENCES users(user_id),
    CONSTRAINT fk_prompt_templates_published_by FOREIGN KEY (published_by) REFERENCES users(user_id),
    
    -- 唯一约束
    CONSTRAINT uk_prompt_templates_name_version UNIQUE (template_name, version, deleted_at)
);

-- 索引
CREATE INDEX idx_prompt_templates_name ON prompt_templates(template_name);
CREATE INDEX idx_prompt_templates_type ON prompt_templates(template_type);
CREATE INDEX idx_prompt_templates_agent_type ON prompt_templates(agent_type);
CREATE INDEX idx_prompt_templates_task_type ON prompt_templates(task_type);
CREATE INDEX idx_prompt_templates_category ON prompt_templates(category);
CREATE INDEX idx_prompt_templates_active ON prompt_templates(is_active, is_published);
CREATE INDEX idx_prompt_templates_usage ON prompt_templates(usage_count DESC);
CREATE INDEX idx_prompt_templates_rating ON prompt_templates(average_rating DESC);

-- GIN索引
CREATE INDEX idx_prompt_templates_tags_gin ON prompt_templates USING GIN (tags);
CREATE INDEX idx_prompt_templates_variables_gin ON prompt_templates USING GIN (template_variables);

-- 全文搜索索引
CREATE INDEX idx_prompt_templates_content_fts ON prompt_templates 
    USING GIN (to_tsvector('english', template_content));

-- 复合索引
CREATE INDEX idx_prompt_templates_agent_task ON prompt_templates(agent_type, task_type, is_active);

-- 触发器
CREATE TRIGGER trigger_prompt_templates_updated_at
    BEFORE UPDATE ON prompt_templates
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();

-- 注释
COMMENT ON TABLE prompt_templates IS 'Prompt模板管理表';
COMMENT ON COLUMN prompt_templates.template_variables IS '模板变量定义，JSON格式';
COMMENT ON COLUMN prompt_templates.validation_rules IS '模板验证规则，JSON格式';
COMMENT ON COLUMN prompt_templates.usage_count IS '模板使用次数统计';
```

#### 2.4.2 Prompt使用记录表 (prompt_usage_logs)

```sql
-- Prompt使用记录表(按日分区)
CREATE TABLE prompt_usage_logs (
    -- 主键
    usage_id UUID DEFAULT uuid_generate_v4(),
    template_id UUID NOT NULL,
    
    -- 使用信息
    agent_id UUID,
    task_id UUID,
    user_id UUID,
    
    -- 执行信息
    rendered_prompt TEXT,
    input_variables JSONB,
    execution_result VARCHAR(20),
    response_time DECIMAL(10,3),
    
    -- 质量评估
    success BOOLEAN,
    rating INTEGER,  -- 1-5星评分
    feedback TEXT,
    
    -- 资源消耗
    input_tokens INTEGER,
    output_tokens INTEGER,
    total_cost DECIMAL(10,4),
    
    -- 审计字段
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    
    -- 主键(包含分区键)
    PRIMARY KEY (usage_id, created_at),
    
    -- 外键约束
    CONSTRAINT fk_prompt_usage_template FOREIGN KEY (template_id) REFERENCES prompt_templates(template_id),
    CONSTRAINT fk_prompt_usage_agent FOREIGN KEY (agent_id) REFERENCES agents(agent_id),
    CONSTRAINT fk_prompt_usage_task FOREIGN KEY (task_id) REFERENCES tasks(task_id),
    CONSTRAINT fk_prompt_usage_user FOREIGN KEY (user_id) REFERENCES users(user_id),
    
    -- 检查约束
    CONSTRAINT ck_prompt_usage_rating CHECK (rating >= 1 AND rating <= 5),
    CONSTRAINT ck_prompt_usage_response_time CHECK (response_time >= 0),
    CONSTRAINT ck_prompt_usage_tokens CHECK (input_tokens >= 0 AND output_tokens >= 0),
    CONSTRAINT ck_prompt_usage_cost CHECK (total_cost >= 0)
    
) PARTITION BY RANGE (created_at);

-- 创建日分区表
CREATE TABLE prompt_usage_logs_2024_01_24 PARTITION OF prompt_usage_logs
    FOR VALUES FROM ('2024-01-24') TO ('2024-01-25');

-- 分区索引
CREATE INDEX idx_prompt_usage_logs_template_id ON prompt_usage_logs(template_id, created_at);
CREATE INDEX idx_prompt_usage_logs_agent_id ON prompt_usage_logs(agent_id, created_at);
CREATE INDEX idx_prompt_usage_logs_success ON prompt_usage_logs(success, created_at);

-- 注释
COMMENT ON TABLE prompt_usage_logs IS 'Prompt使用记录表，按日分区存储';
```

---

## 🔧 辅助表和系统表设计

### 3.1 系统配置表

#### 3.1.1 系统配置表 (system_configs)

```sql
-- 系统配置表
CREATE TABLE system_configs (
    -- 主键
    config_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    
    -- 配置信息
    config_key VARCHAR(100) UNIQUE NOT NULL,
    config_value TEXT,
    config_type VARCHAR(20) NOT NULL DEFAULT 'string',
    
    -- 分组和描述
    config_group VARCHAR(50),
    description TEXT,
    
    -- 配置属性
    is_encrypted BOOLEAN NOT NULL DEFAULT false,
    is_system_config BOOLEAN NOT NULL DEFAULT false,
    requires_restart BOOLEAN NOT NULL DEFAULT false,
    
    -- 验证规则
    validation_regex VARCHAR(500),
    allowed_values JSONB,
    
    -- 审计字段
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    created_by UUID NOT NULL,
    updated_by UUID,
    
    -- 约束
    CONSTRAINT ck_system_configs_type CHECK (config_type IN ('string', 'integer', 'boolean', 'json', 'decimal')),
    CONSTRAINT ck_system_configs_key_format CHECK (config_key ~ '^[a-z0-9_\.]+$'),
    CONSTRAINT fk_system_configs_created_by FOREIGN KEY (created_by) REFERENCES users(user_id)
);

-- 索引
CREATE INDEX idx_system_configs_group ON system_configs(config_group);
CREATE INDEX idx_system_configs_system ON system_configs(is_system_config);

-- 注释
COMMENT ON TABLE system_configs IS '系统配置表';
COMMENT ON COLUMN system_configs.is_encrypted IS '配置值是否加密存储';
```

#### 3.1.2 数据字典表 (data_dictionaries)

```sql
-- 数据字典表
CREATE TABLE data_dictionaries (
    -- 主键
    dict_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    
    -- 字典信息
    dict_type VARCHAR(50) NOT NULL,
    dict_code VARCHAR(50) NOT NULL,
    dict_value VARCHAR(200) NOT NULL,
    
    -- 层级关系
    parent_code VARCHAR(50),
    level_num INTEGER NOT NULL DEFAULT 1,
    sort_order INTEGER NOT NULL DEFAULT 0,
    
    -- 状态信息
    is_active BOOLEAN NOT NULL DEFAULT true,
    
    -- 扩展信息
    description TEXT,
    extra_data JSONB DEFAULT '{}',
    
    -- 审计字段
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    created_by UUID NOT NULL,
    updated_by UUID,
    
    -- 约束
    CONSTRAINT uk_data_dictionaries_type_code UNIQUE (dict_type, dict_code),
    CONSTRAINT ck_data_dictionaries_level CHECK (level_num > 0),
    CONSTRAINT fk_data_dictionaries_created_by FOREIGN KEY (created_by) REFERENCES users(user_id)
);

-- 索引
CREATE INDEX idx_data_dictionaries_type ON data_dictionaries(dict_type);
CREATE INDEX idx_data_dictionaries_parent ON data_dictionaries(parent_code);
CREATE INDEX idx_data_dictionaries_active ON data_dictionaries(is_active);
CREATE INDEX idx_data_dictionaries_sort ON data_dictionaries(dict_type, sort_order);

-- 注释
COMMENT ON TABLE data_dictionaries IS '数据字典表，存储系统枚举值';
```

### 3.2 日志和审计表

#### 3.2.1 系统日志表 (system_logs)

```sql
-- 系统日志表(按日分区)
CREATE TABLE system_logs (
    -- 主键
    log_id UUID DEFAULT uuid_generate_v4(),
    
    -- 日志信息
    log_level VARCHAR(10) NOT NULL,
    logger_name VARCHAR(100) NOT NULL,
    message TEXT NOT NULL,
    
    -- 上下文信息
    module_name VARCHAR(50),
    function_name VARCHAR(100),
    line_number INTEGER,
    
    -- 请求信息
    request_id VARCHAR(50),
    user_id UUID,
    session_id VARCHAR(100),
    ip_address INET,
    user_agent TEXT,
    
    -- 异常信息
    exception_type VARCHAR(100),
    stack_trace TEXT,
    
    -- 时间信息
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    
    -- 主键(包含分区键)
    PRIMARY KEY (log_id, created_at),
    
    -- 约束
    CONSTRAINT ck_system_logs_level CHECK (log_level IN ('DEBUG', 'INFO', 'WARN', 'ERROR', 'FATAL')),
    CONSTRAINT fk_system_logs_user FOREIGN KEY (user_id) REFERENCES users(user_id)
    
) PARTITION BY RANGE (created_at);

-- 分区索引
CREATE INDEX idx_system_logs_level ON system_logs(log_level, created_at);
CREATE INDEX idx_system_logs_module ON system_logs(module_name, created_at);
CREATE INDEX idx_system_logs_user ON system_logs(user_id, created_at);
CREATE INDEX idx_system_logs_request ON system_logs(request_id, created_at);

-- 全文搜索索引
CREATE INDEX idx_system_logs_message_fts ON system_logs 
    USING GIN (to_tsvector('english', message));

-- 注释
COMMENT ON TABLE system_logs IS '系统日志表，按日分区存储';
```

#### 3.2.2 操作审计表 (audit_logs)

```sql
-- 操作审计表(按月分区)  
CREATE TABLE audit_logs (
    -- 主键
    audit_id UUID DEFAULT uuid_generate_v4(),
    
    -- 审计信息
    table_name VARCHAR(50) NOT NULL,
    record_id UUID NOT NULL,
    operation VARCHAR(10) NOT NULL,
    
    -- 变更数据
    old_values JSONB,
    new_values JSONB,
    changed_fields JSONB,
    
    -- 操作者信息
    user_id UUID,
    username VARCHAR(50),
    ip_address INET,
    user_agent TEXT,
    
    -- 时间信息
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    
    -- 主键(包含分区键)
    PRIMARY KEY (audit_id, created_at),
    
    -- 约束
    CONSTRAINT ck_audit_logs_operation CHECK (operation IN ('INSERT', 'UPDATE', 'DELETE')),
    CONSTRAINT fk_audit_logs_user FOREIGN KEY (user_id) REFERENCES users(user_id)
    
) PARTITION BY RANGE (created_at);

-- 分区索引
CREATE INDEX idx_audit_logs_table_record ON audit_logs(table_name, record_id, created_at);
CREATE INDEX idx_audit_logs_user ON audit_logs(user_id, created_at);
CREATE INDEX idx_audit_logs_operation ON audit_logs(operation, created_at);

-- 注释
COMMENT ON TABLE audit_logs IS '操作审计表，记录数据变更历史';
```

---

## 📈 性能优化表设计

### 4.1 统计汇总表

#### 4.1.1 Agent性能汇总表 (agent_performance_summary)

```sql
-- Agent性能汇总表(物化视图)
CREATE TABLE agent_performance_summary (
    -- 主键  
    agent_id UUID PRIMARY KEY,
    
    -- 基础信息(冗余存储)
    agent_type VARCHAR(50) NOT NULL,
    agent_name VARCHAR(100) NOT NULL,
    
    -- 统计时间范围
    stats_date DATE NOT NULL DEFAULT CURRENT_DATE,
    last_updated TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    
    -- 任务统计
    total_tasks INTEGER NOT NULL DEFAULT 0,
    completed_tasks INTEGER NOT NULL DEFAULT 0,
    failed_tasks INTEGER NOT NULL DEFAULT 0,
    cancelled_tasks INTEGER NOT NULL DEFAULT 0,
    
    -- 性能指标
    success_rate DECIMAL(5,2) NOT NULL DEFAULT 0,
    average_execution_time DECIMAL(10,3) NOT NULL DEFAULT 0,
    median_execution_time DECIMAL(10,3) NOT NULL DEFAULT 0,
    p95_execution_time DECIMAL(10,3) NOT NULL DEFAULT 0,
    
    -- 资源使用
    average_memory_usage DECIMAL(10,2) NOT NULL DEFAULT 0,
    average_cpu_usage DECIMAL(5,2) NOT NULL DEFAULT 0,
    peak_memory_usage DECIMAL(10,2) NOT NULL DEFAULT 0,
    peak_cpu_usage DECIMAL(5,2) NOT NULL DEFAULT 0,
    
    -- 质量指标
    average_confidence_score DECIMAL(3,2) NOT NULL DEFAULT 0,
    total_prompt_tokens BIGINT NOT NULL DEFAULT 0,
    total_completion_tokens BIGINT NOT NULL DEFAULT 0,
    total_cost DECIMAL(12,4) NOT NULL DEFAULT 0,
    
    -- 外键约束
    CONSTRAINT fk_agent_performance_agent FOREIGN KEY (agent_id) REFERENCES agents(agent_id) ON DELETE CASCADE
);

-- 索引
CREATE INDEX idx_agent_performance_stats_date ON agent_performance_summary(stats_date);
CREATE INDEX idx_agent_performance_success_rate ON agent_performance_summary(success_rate DESC);
CREATE INDEX idx_agent_performance_avg_time ON agent_performance_summary(average_execution_time);
CREATE INDEX idx_agent_performance_type ON agent_performance_summary(agent_type, success_rate DESC);

-- 自动更新触发器
CREATE OR REPLACE FUNCTION refresh_agent_performance_summary()
RETURNS void AS $$
BEGIN
    INSERT INTO agent_performance_summary (
        agent_id, agent_type, agent_name, stats_date,
        total_tasks, completed_tasks, failed_tasks,
        success_rate, average_execution_time,
        average_memory_usage, average_cpu_usage
    )
    SELECT 
        a.agent_id,
        a.agent_type,
        a.agent_name,
        CURRENT_DATE,
        COUNT(t.task_id),
        COUNT(CASE WHEN t.status = 'completed' THEN 1 END),
        COUNT(CASE WHEN t.status = 'failed' THEN 1 END),
        ROUND(
            COUNT(CASE WHEN t.status = 'completed' THEN 1 END) * 100.0 / 
            NULLIF(COUNT(t.task_id), 0), 2
        ),
        ROUND(AVG(te.execution_time), 3),
        ROUND(AVG(te.memory_usage_mb), 2),
        ROUND(AVG(te.cpu_usage_percent), 2)
    FROM agents a
    LEFT JOIN tasks t ON a.agent_id = t.assigned_agent 
        AND t.created_at >= CURRENT_DATE
    LEFT JOIN task_executions te ON t.task_id = te.task_id
    WHERE a.deleted_at IS NULL
    GROUP BY a.agent_id, a.agent_type, a.agent_name
    ON CONFLICT (agent_id) DO UPDATE SET
        total_tasks = EXCLUDED.total_tasks,
        completed_tasks = EXCLUDED.completed_tasks,
        failed_tasks = EXCLUDED.failed_tasks,
        success_rate = EXCLUDED.success_rate,
        average_execution_time = EXCLUDED.average_execution_time,
        average_memory_usage = EXCLUDED.average_memory_usage,
        average_cpu_usage = EXCLUDED.average_cpu_usage,
        last_updated = CURRENT_TIMESTAMP;
END;
$$ LANGUAGE plpgsql;

-- 注释
COMMENT ON TABLE agent_performance_summary IS 'Agent性能汇总表，每日更新统计数据';
```

### 4.2 缓存表设计

#### 4.2.1 热点数据缓存表

```sql
-- 热点查询缓存表
CREATE TABLE cache_entries (
    -- 主键
    cache_key VARCHAR(255) PRIMARY KEY,
    
    -- 缓存数据
    cache_value JSONB NOT NULL,
    cache_type VARCHAR(50) NOT NULL,
    
    -- 缓存元数据
    ttl_seconds INTEGER NOT NULL DEFAULT 3600,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    accessed_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    access_count INTEGER NOT NULL DEFAULT 0,
    
    -- 自动过期
    expires_at TIMESTAMP NOT NULL DEFAULT (CURRENT_TIMESTAMP + INTERVAL '1 hour'),
    
    -- 约束
    CONSTRAINT ck_cache_entries_ttl CHECK (ttl_seconds > 0)
);

-- 索引
CREATE INDEX idx_cache_entries_expires_at ON cache_entries(expires_at);
CREATE INDEX idx_cache_entries_type ON cache_entries(cache_type);
CREATE INDEX idx_cache_entries_accessed_at ON cache_entries(accessed_at);

-- 自动清理过期缓存
CREATE OR REPLACE FUNCTION cleanup_expired_cache()
RETURNS INTEGER AS $$
DECLARE
    deleted_count INTEGER;
BEGIN
    DELETE FROM cache_entries WHERE expires_at < CURRENT_TIMESTAMP;
    GET DIAGNOSTICS deleted_count = ROW_COUNT;
    RETURN deleted_count;
END;
$$ LANGUAGE plpgsql;

-- 注释
COMMENT ON TABLE cache_entries IS '应用级缓存表，存储热点查询结果';
```

---

## 📋 表结构检查清单

### 5.1 设计检查清单

#### 5.1.1 基础结构检查
- [ ] **主键设计**
  - [ ] 使用UUID作为主键
  - [ ] 主键字段命名为{table}_id
  - [ ] 主键设置DEFAULT uuid_generate_v4()

- [ ] **必需字段检查**
  - [ ] created_at字段已添加
  - [ ] updated_at字段已添加  
  - [ ] created_by字段已添加
  - [ ] 相关触发器已创建

- [ ] **约束检查**
  - [ ] NOT NULL约束正确设置
  - [ ] CHECK约束逻辑正确
  - [ ] 外键约束已建立
  - [ ] 唯一约束合理设置

#### 5.1.2 性能优化检查
- [ ] **索引设计**
  - [ ] 主要查询字段已建索引
  - [ ] 外键字段已建索引
  - [ ] 复合索引顺序合理
  - [ ] JSONB字段使用GIN索引

- [ ] **分区设计**
  - [ ] 大表考虑分区策略
  - [ ] 分区键选择合理
  - [ ] 分区表索引已创建

#### 5.1.3 安全性检查
- [ ] **敏感数据处理**
  - [ ] 密码字段使用哈希存储
  - [ ] 敏感信息考虑加密
  - [ ] PII数据标识清晰

- [ ] **审计设计**
  - [ ] 关键表启用审计
  - [ ] 审计触发器正确配置
  - [ ] 软删除机制完整

### 5.2 代码生成模板

#### 5.2.1 标准表创建模板

```sql
-- 表创建模板
-- 表名: {table_name}
-- 描述: {table_description}
-- 创建日期: {creation_date}

CREATE TABLE {table_name} (
    -- 主键
    {table_name}_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    
    -- 业务字段
    {business_fields}
    
    -- 状态字段(可选)
    status VARCHAR(20) NOT NULL DEFAULT 'active',
    
    -- 审计字段
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    created_by UUID NOT NULL,
    updated_by UUID,
    
    -- 软删除(可选)
    deleted_at TIMESTAMP,
    deleted_by UUID,
    
    -- 约束
    {constraints}
    
    -- 外键
    {foreign_keys}
);

-- 索引
{indexes}

-- 触发器
CREATE TRIGGER trigger_{table_name}_updated_at
    BEFORE UPDATE ON {table_name}
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();

-- 注释
COMMENT ON TABLE {table_name} IS '{table_description}';
{column_comments}
```

---

**文档状态**: 正式发布  
**最后更新**: 2024-01-24  
**下次评审**: 2024-04-24  
**批准人**: 数据建模委员会