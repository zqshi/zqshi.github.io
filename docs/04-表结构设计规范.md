# æ•°å­—å‘˜å·¥ç³»ç»Ÿè¡¨ç»“æ„è®¾è®¡è§„èŒƒ
## Digital Employee System Table Structure Design Standards v1.0

### ğŸ“‹ æ–‡æ¡£ä¿¡æ¯
- **æ–‡æ¡£ç‰ˆæœ¬**: v1.0
- **åˆ›å»ºæ—¥æœŸ**: 2024-01-24
- **é€‚ç”¨èŒƒå›´**: æ•°å­—å‘˜å·¥ç³»ç»Ÿæ‰€æœ‰æ•°æ®è¡¨è®¾è®¡
- **ç»´æŠ¤éƒ¨é—¨**: æ•°æ®å»ºæ¨¡ç»„

---

## ğŸ—ï¸ è¡¨ç»“æ„è®¾è®¡åŸåˆ™

### 1.1 åŸºç¡€è®¾è®¡åŸåˆ™

#### 1.1.1 è¡¨å‘½åè§„èŒƒ

| å‘½åç±»å‹ | è§„èŒƒ | ç¤ºä¾‹ | è¯´æ˜ |
|---------|------|------|------|
| **è¡¨å** | å¤æ•°å½¢å¼ï¼Œä¸‹åˆ’çº¿åˆ†éš” | `users`, `agent_tasks` | è¡¨ç¤ºæ•°æ®é›†åˆ |
| **ä¸»é”®** | è¡¨åå•æ•°_id | `user_id`, `agent_id` | ç»Ÿä¸€ä¸»é”®å‘½å |
| **å¤–é”®** | å¼•ç”¨è¡¨å•æ•°_id | `created_by`, `assigned_agent` | æ¸…æ™°å¼•ç”¨å…³ç³» |
| **ç´¢å¼•** | idx_è¡¨å_å­—æ®µå | `idx_users_email` | ä¾¿äºç®¡ç†ç»´æŠ¤ |
| **çº¦æŸ** | ck_è¡¨å_çº¦æŸæè¿° | `ck_tasks_status` | æè¿°çº¦æŸç”¨é€” |

#### 1.1.2 è¡¨ç»“æ„æ ‡å‡†

```sql
-- æ ‡å‡†è¡¨ç»“æ„æ¨¡æ¿
CREATE TABLE table_name (
    -- 1. ä¸»é”® (å¿…é¡»)
    table_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    
    -- 2. ä¸šåŠ¡å­—æ®µ (æŒ‰é‡è¦æ€§æ’åº)
    business_field_1 VARCHAR(100) NOT NULL,
    business_field_2 TEXT,
    business_field_3 JSONB DEFAULT '{}',
    
    -- 3. çŠ¶æ€å­—æ®µ (å¦‚éœ€è¦)
    status VARCHAR(20) NOT NULL DEFAULT 'active',
    
    -- 4. å®¡è®¡å­—æ®µ (æ ‡å‡†)
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    created_by UUID,
    updated_by UUID,
    
    -- 5. è½¯åˆ é™¤å­—æ®µ (å¦‚éœ€è¦)
    deleted_at TIMESTAMP NULL,
    deleted_by UUID,
    
    -- 6. ç‰ˆæœ¬æ§åˆ¶å­—æ®µ (å¦‚éœ€è¦)
    version INTEGER NOT NULL DEFAULT 1,
    
    -- 7. çº¦æŸå®šä¹‰
    CONSTRAINT ck_table_status CHECK (status IN ('active', 'inactive', 'deleted')),
    CONSTRAINT fk_table_created_by FOREIGN KEY (created_by) REFERENCES users(user_id),
    CONSTRAINT fk_table_updated_by FOREIGN KEY (updated_by) REFERENCES users(user_id)
);

-- 8. æ ‡å‡†ç´¢å¼•
CREATE INDEX idx_table_status ON table_name(status);
CREATE INDEX idx_table_created_at ON table_name(created_at);
CREATE INDEX idx_table_created_by ON table_name(created_by);

-- 9. æ›´æ–°æ—¶é—´è§¦å‘å™¨
CREATE TRIGGER trigger_table_updated_at
    BEFORE UPDATE ON table_name
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();

-- 10. è¡¨æ³¨é‡Š
COMMENT ON TABLE table_name IS 'è¡¨åŠŸèƒ½æè¿°';
COMMENT ON COLUMN table_name.business_field_1 IS 'ä¸šåŠ¡å­—æ®µ1æè¿°';
```

### 1.2 å­—æ®µè®¾è®¡æ ‡å‡†

#### 1.2.1 å¿…éœ€å­—æ®µè§„èŒƒ

| å­—æ®µç±»å‹ | å­—æ®µå | æ•°æ®ç±»å‹ | çº¦æŸ | è¯´æ˜ |
|---------|--------|----------|------|------|
| **ä¸»é”®** | {table}_id | UUID | PRIMARY KEY | å…¨å±€å”¯ä¸€æ ‡è¯† |
| **åˆ›å»ºæ—¶é—´** | created_at | TIMESTAMP | NOT NULL | è®°å½•åˆ›å»ºæ—¶é—´ |
| **æ›´æ–°æ—¶é—´** | updated_at | TIMESTAMP | NOT NULL | è®°å½•æœ€åæ›´æ–°æ—¶é—´ |
| **åˆ›å»ºäºº** | created_by | UUID | å¤–é”®å¼•ç”¨users | è®°å½•åˆ›å»ºè€… |
| **æ›´æ–°äºº** | updated_by | UUID | å¤–é”®å¼•ç”¨users | è®°å½•æœ€åæ›´æ–°è€… |

#### 1.2.2 å¯é€‰å­—æ®µè§„èŒƒ

| å­—æ®µç±»å‹ | å­—æ®µå | æ•°æ®ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|---------|--------|----------|--------|------|
| **çŠ¶æ€å­—æ®µ** | status | VARCHAR(20) | 'active' | è®°å½•çŠ¶æ€ |
| **è½¯åˆ é™¤** | deleted_at | TIMESTAMP | NULL | è½¯åˆ é™¤æ—¶é—´ |
| **åˆ é™¤äºº** | deleted_by | UUID | NULL | è½¯åˆ é™¤æ“ä½œè€… |
| **ç‰ˆæœ¬å·** | version | INTEGER | 1 | ä¹è§‚é”ç‰ˆæœ¬æ§åˆ¶ |
| **æ’åº** | sort_order | INTEGER | 0 | æ˜¾ç¤ºæ’åº |
| **å¤‡æ³¨** | remark | TEXT | NULL | é™„åŠ è¯´æ˜ |

---

## ğŸ“Š æ ¸å¿ƒä¸šåŠ¡è¡¨è®¾è®¡

### 2.1 ç”¨æˆ·ç®¡ç†åŸŸè¡¨ç»“æ„

#### 2.1.1 ç”¨æˆ·è¡¨ (users)

```sql
-- ç”¨æˆ·åŸºç¡€ä¿¡æ¯è¡¨
CREATE TABLE users (
    -- ä¸»é”®
    user_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    
    -- åŸºç¡€ä¿¡æ¯
    username VARCHAR(50) UNIQUE NOT NULL,
    email_hash VARCHAR(64) UNIQUE NOT NULL,  -- é‚®ç®±å“ˆå¸Œ(ç”¨äºæŸ¥è¯¢)
    email_encrypted BYTEA NOT NULL,          -- åŠ å¯†é‚®ç®±
    phone_hash VARCHAR(64),                  -- æ‰‹æœºå·å“ˆå¸Œ
    phone_encrypted BYTEA,                   -- åŠ å¯†æ‰‹æœºå·
    password_hash VARCHAR(255) NOT NULL,     -- å¯†ç å“ˆå¸Œ
    
    -- ç”¨æˆ·å±æ€§
    display_name VARCHAR(100) NOT NULL,
    avatar_url VARCHAR(500),
    timezone VARCHAR(50) DEFAULT 'UTC',
    locale VARCHAR(10) DEFAULT 'zh-CN',
    
    -- çŠ¶æ€ä¿¡æ¯
    status VARCHAR(20) NOT NULL DEFAULT 'active',
    is_verified BOOLEAN NOT NULL DEFAULT false,
    email_verified_at TIMESTAMP,
    last_login_at TIMESTAMP,
    last_login_ip INET,
    
    -- å®‰å…¨è®¾ç½®
    mfa_enabled BOOLEAN NOT NULL DEFAULT false,
    mfa_secret VARCHAR(32),
    failed_login_attempts INTEGER NOT NULL DEFAULT 0,
    locked_until TIMESTAMP,
    
    -- å®¡è®¡å­—æ®µ
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    created_by UUID,
    updated_by UUID,
    
    -- è½¯åˆ é™¤
    deleted_at TIMESTAMP,
    deleted_by UUID,
    
    -- çº¦æŸ
    CONSTRAINT ck_users_status CHECK (status IN ('active', 'inactive', 'suspended', 'deleted')),
    CONSTRAINT ck_users_email_format CHECK (email_hash ~ '^[a-f0-9]{64}$'),
    CONSTRAINT ck_users_failed_attempts CHECK (failed_login_attempts >= 0),
    CONSTRAINT fk_users_created_by FOREIGN KEY (created_by) REFERENCES users(user_id),
    CONSTRAINT fk_users_updated_by FOREIGN KEY (updated_by) REFERENCES users(user_id)
);

-- ç´¢å¼•
CREATE INDEX idx_users_username ON users(username);
CREATE INDEX idx_users_email_hash ON users(email_hash);
CREATE INDEX idx_users_phone_hash ON users(phone_hash);
CREATE INDEX idx_users_status ON users(status);
CREATE INDEX idx_users_created_at ON users(created_at);
CREATE INDEX idx_users_last_login ON users(last_login_at);
CREATE UNIQUE INDEX idx_users_active_username ON users(username) WHERE deleted_at IS NULL;

-- è§¦å‘å™¨
CREATE TRIGGER trigger_users_updated_at
    BEFORE UPDATE ON users
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();

-- æ³¨é‡Š
COMMENT ON TABLE users IS 'ç”¨æˆ·åŸºç¡€ä¿¡æ¯è¡¨';
COMMENT ON COLUMN users.email_hash IS 'é‚®ç®±SHA256å“ˆå¸Œå€¼ï¼Œç”¨äºæŸ¥è¯¢';
COMMENT ON COLUMN users.email_encrypted IS 'åŠ å¯†å­˜å‚¨çš„é‚®ç®±åœ°å€';
COMMENT ON COLUMN users.mfa_enabled IS 'æ˜¯å¦å¯ç”¨å¤šå› å­è®¤è¯';
COMMENT ON COLUMN users.failed_login_attempts IS 'è¿ç»­ç™»å½•å¤±è´¥æ¬¡æ•°';
```

#### 2.1.2 ç”¨æˆ·è§’è‰²è¡¨ (user_roles)

```sql
-- ç”¨æˆ·è§’è‰²å…³ç³»è¡¨
CREATE TABLE user_roles (
    -- ä¸»é”®
    assignment_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    
    -- å…³è”å­—æ®µ
    user_id UUID NOT NULL,
    role_id UUID NOT NULL,
    
    -- è§’è‰²å±æ€§
    granted_by UUID NOT NULL,
    granted_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    expires_at TIMESTAMP,  -- è§’è‰²è¿‡æœŸæ—¶é—´
    
    -- çŠ¶æ€
    is_active BOOLEAN NOT NULL DEFAULT true,
    
    -- å®¡è®¡å­—æ®µ
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    created_by UUID,
    updated_by UUID,
    
    -- å¤–é”®çº¦æŸ
    CONSTRAINT fk_user_roles_user FOREIGN KEY (user_id) REFERENCES users(user_id) ON DELETE CASCADE,
    CONSTRAINT fk_user_roles_role FOREIGN KEY (role_id) REFERENCES roles(role_id) ON DELETE CASCADE,
    CONSTRAINT fk_user_roles_granted_by FOREIGN KEY (granted_by) REFERENCES users(user_id),
    
    -- å”¯ä¸€çº¦æŸ
    CONSTRAINT uk_user_roles_active UNIQUE (user_id, role_id, is_active)
);

-- ç´¢å¼•
CREATE INDEX idx_user_roles_user_id ON user_roles(user_id);
CREATE INDEX idx_user_roles_role_id ON user_roles(role_id);
CREATE INDEX idx_user_roles_expires_at ON user_roles(expires_at);
CREATE INDEX idx_user_roles_active ON user_roles(is_active, expires_at);

-- æ³¨é‡Š
COMMENT ON TABLE user_roles IS 'ç”¨æˆ·è§’è‰²å…³ç³»è¡¨';
COMMENT ON COLUMN user_roles.expires_at IS 'è§’è‰²è¿‡æœŸæ—¶é—´ï¼ŒNULLè¡¨ç¤ºæ°¸ä¸è¿‡æœŸ';
```

### 2.2 Agentç®¡ç†åŸŸè¡¨ç»“æ„

#### 2.2.1 Agentä¸»è¡¨ (agents)

```sql
-- AgentåŸºç¡€ä¿¡æ¯è¡¨
CREATE TABLE agents (
    -- ä¸»é”®
    agent_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    
    -- åŸºç¡€ä¿¡æ¯
    agent_type VARCHAR(50) NOT NULL,
    agent_name VARCHAR(100) NOT NULL,
    version VARCHAR(20) NOT NULL DEFAULT '1.0.0',
    description TEXT,
    
    -- é…ç½®ä¿¡æ¯
    config JSONB NOT NULL DEFAULT '{}',
    capabilities JSONB NOT NULL DEFAULT '[]',
    constraints JSONB NOT NULL DEFAULT '{}',
    
    -- è¿è¡ŒçŠ¶æ€
    status VARCHAR(20) NOT NULL DEFAULT 'inactive',
    health_status VARCHAR(20) NOT NULL DEFAULT 'unknown',
    last_heartbeat TIMESTAMP,
    
    -- æ€§èƒ½è®¾ç½®
    max_concurrent_tasks INTEGER NOT NULL DEFAULT 10,
    timeout_seconds INTEGER NOT NULL DEFAULT 300,
    priority_level INTEGER NOT NULL DEFAULT 5,
    
    -- èµ„æºé™åˆ¶
    memory_limit_mb INTEGER DEFAULT 512,
    cpu_limit_cores DECIMAL(3,2) DEFAULT 0.5,
    
    -- ç»Ÿè®¡ä¿¡æ¯
    total_tasks_executed INTEGER NOT NULL DEFAULT 0,
    successful_tasks INTEGER NOT NULL DEFAULT 0,
    failed_tasks INTEGER NOT NULL DEFAULT 0,
    average_execution_time DECIMAL(10,3) DEFAULT 0,
    
    -- å®¡è®¡å­—æ®µ
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    created_by UUID NOT NULL,
    updated_by UUID,
    
    -- è½¯åˆ é™¤
    deleted_at TIMESTAMP,
    deleted_by UUID,
    
    -- ç‰ˆæœ¬æ§åˆ¶
    version_number INTEGER NOT NULL DEFAULT 1,
    
    -- çº¦æŸ
    CONSTRAINT ck_agents_status CHECK (status IN ('active', 'inactive', 'suspended', 'maintenance', 'deleted')),
    CONSTRAINT ck_agents_health CHECK (health_status IN ('healthy', 'degraded', 'unhealthy', 'unknown')),
    CONSTRAINT ck_agents_priority CHECK (priority_level BETWEEN 1 AND 10),
    CONSTRAINT ck_agents_max_tasks CHECK (max_concurrent_tasks > 0),
    CONSTRAINT ck_agents_timeout CHECK (timeout_seconds > 0),
    CONSTRAINT ck_agents_memory CHECK (memory_limit_mb > 0),
    CONSTRAINT ck_agents_cpu CHECK (cpu_limit_cores > 0),
    CONSTRAINT ck_agents_config_structure CHECK (jsonb_typeof(config) = 'object'),
    CONSTRAINT ck_agents_capabilities_structure CHECK (jsonb_typeof(capabilities) = 'array'),
    
    -- å¤–é”®
    CONSTRAINT fk_agents_created_by FOREIGN KEY (created_by) REFERENCES users(user_id),
    CONSTRAINT fk_agents_updated_by FOREIGN KEY (updated_by) REFERENCES users(user_id),
    
    -- å”¯ä¸€çº¦æŸ
    CONSTRAINT uk_agents_type_version UNIQUE (agent_type, version, deleted_at)
);

-- ç´¢å¼•
CREATE INDEX idx_agents_type ON agents(agent_type);
CREATE INDEX idx_agents_status ON agents(status);
CREATE INDEX idx_agents_health_status ON agents(health_status);
CREATE INDEX idx_agents_created_by ON agents(created_by);
CREATE INDEX idx_agents_created_at ON agents(created_at);
CREATE INDEX idx_agents_last_heartbeat ON agents(last_heartbeat);
CREATE INDEX idx_agents_priority ON agents(priority_level);

-- GINç´¢å¼•ç”¨äºJSONBå­—æ®µ
CREATE INDEX idx_agents_config_gin ON agents USING GIN (config);
CREATE INDEX idx_agents_capabilities_gin ON agents USING GIN (capabilities);

-- å¤åˆç´¢å¼•
CREATE INDEX idx_agents_active_status ON agents(status, health_status) WHERE deleted_at IS NULL;
CREATE INDEX idx_agents_performance ON agents(agent_type, successful_tasks, average_execution_time);

-- è§¦å‘å™¨
CREATE TRIGGER trigger_agents_updated_at
    BEFORE UPDATE ON agents
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();

-- ç»Ÿè®¡ä¿¡æ¯æ›´æ–°è§¦å‘å™¨
CREATE OR REPLACE FUNCTION update_agent_statistics()
RETURNS TRIGGER AS $$
BEGIN
    -- æ›´æ–°ç‰ˆæœ¬å·(ä¹è§‚é”)
    NEW.version_number = OLD.version_number + 1;
    
    -- é‡æ–°è®¡ç®—å¹³å‡æ‰§è¡Œæ—¶é—´
    IF NEW.total_tasks_executed > 0 THEN
        NEW.average_execution_time = (
            OLD.average_execution_time * OLD.total_tasks_executed + 
            COALESCE(NEW.average_execution_time, 0)
        ) / NEW.total_tasks_executed;
    END IF;
    
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trigger_agents_statistics
    BEFORE UPDATE ON agents
    FOR EACH ROW
    EXECUTE FUNCTION update_agent_statistics();

-- æ³¨é‡Š
COMMENT ON TABLE agents IS 'AgentåŸºç¡€ä¿¡æ¯å’Œé…ç½®è¡¨';
COMMENT ON COLUMN agents.config IS 'Agenté…ç½®ä¿¡æ¯ï¼ŒJSONæ ¼å¼';
COMMENT ON COLUMN agents.capabilities IS 'Agentèƒ½åŠ›åˆ—è¡¨ï¼ŒJSONæ•°ç»„æ ¼å¼';
COMMENT ON COLUMN agents.constraints IS 'Agentçº¦æŸæ¡ä»¶ï¼ŒJSONæ ¼å¼';
COMMENT ON COLUMN agents.health_status IS 'Agentå¥åº·çŠ¶æ€';
COMMENT ON COLUMN agents.version_number IS 'ç‰ˆæœ¬å·ï¼Œç”¨äºä¹è§‚é”æ§åˆ¶';
```

#### 2.2.2 Agentèƒ½åŠ›è¡¨ (agent_capabilities)

```sql
-- Agentèƒ½åŠ›å®šä¹‰è¡¨
CREATE TABLE agent_capabilities (
    -- ä¸»é”®
    capability_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    
    -- åŸºç¡€ä¿¡æ¯
    capability_name VARCHAR(100) NOT NULL,
    capability_type VARCHAR(50) NOT NULL,
    description TEXT,
    
    -- èƒ½åŠ›å±æ€§
    skill_level INTEGER NOT NULL DEFAULT 5,
    tools_required JSONB DEFAULT '[]',
    prerequisites JSONB DEFAULT '[]',
    
    -- çŠ¶æ€
    is_active BOOLEAN NOT NULL DEFAULT true,
    
    -- å®¡è®¡å­—æ®µ
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    created_by UUID NOT NULL,
    updated_by UUID,
    
    -- çº¦æŸ
    CONSTRAINT ck_agent_capabilities_skill_level CHECK (skill_level BETWEEN 1 AND 10),
    CONSTRAINT ck_agent_capabilities_tools_structure CHECK (jsonb_typeof(tools_required) = 'array'),
    CONSTRAINT fk_agent_capabilities_created_by FOREIGN KEY (created_by) REFERENCES users(user_id),
    
    -- å”¯ä¸€çº¦æŸ
    CONSTRAINT uk_agent_capabilities_name UNIQUE (capability_name)
);

-- ç´¢å¼•
CREATE INDEX idx_agent_capabilities_type ON agent_capabilities(capability_type);
CREATE INDEX idx_agent_capabilities_skill_level ON agent_capabilities(skill_level);
CREATE INDEX idx_agent_capabilities_active ON agent_capabilities(is_active);

-- æ³¨é‡Š
COMMENT ON TABLE agent_capabilities IS 'Agentèƒ½åŠ›å®šä¹‰è¡¨';
COMMENT ON COLUMN agent_capabilities.skill_level IS 'èƒ½åŠ›ç­‰çº§ï¼Œ1-10çº§';
```

### 2.3 ä»»åŠ¡ç®¡ç†åŸŸè¡¨ç»“æ„

#### 2.3.1 ä»»åŠ¡ä¸»è¡¨ (tasks)

```sql
-- ä»»åŠ¡ä¸»è¡¨
CREATE TABLE tasks (
    -- ä¸»é”®
    task_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    
    -- åŸºç¡€ä¿¡æ¯
    task_type VARCHAR(50) NOT NULL,
    task_name VARCHAR(200),
    description TEXT,
    
    -- ä»»åŠ¡æ•°æ®
    input_data JSONB NOT NULL DEFAULT '{}',
    output_data JSONB,
    context_data JSONB DEFAULT '{}',
    
    -- ä¼˜å…ˆçº§å’Œè°ƒåº¦
    priority VARCHAR(20) NOT NULL DEFAULT 'normal',
    priority_score INTEGER NOT NULL DEFAULT 5,
    scheduled_at TIMESTAMP,
    deadline TIMESTAMP,
    
    -- çŠ¶æ€ä¿¡æ¯
    status VARCHAR(20) NOT NULL DEFAULT 'pending',
    previous_status VARCHAR(20),
    status_changed_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    -- åˆ†é…ä¿¡æ¯
    assigned_agent UUID,
    assigned_at TIMESTAMP,
    assigned_by UUID,
    
    -- æ‰§è¡Œä¿¡æ¯
    started_at TIMESTAMP,
    completed_at TIMESTAMP,
    execution_time DECIMAL(10,3),
    retry_count INTEGER NOT NULL DEFAULT 0,
    max_retries INTEGER NOT NULL DEFAULT 3,
    
    -- ç»“æœä¿¡æ¯
    result_status VARCHAR(20),
    error_message TEXT,
    error_code VARCHAR(50),
    confidence_score DECIMAL(3,2),
    
    -- ä¾èµ–å…³ç³»
    parent_task_id UUID,
    depends_on JSONB DEFAULT '[]',  -- ä¾èµ–çš„ä»»åŠ¡IDåˆ—è¡¨
    
    -- å®¡è®¡å­—æ®µ
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    created_by UUID NOT NULL,
    updated_by UUID,
    
    -- çº¦æŸ
    CONSTRAINT ck_tasks_status CHECK (status IN (
        'pending', 'queued', 'assigned', 'running', 
        'completed', 'failed', 'cancelled', 'timeout'
    )),
    CONSTRAINT ck_tasks_priority CHECK (priority IN ('low', 'normal', 'high', 'urgent', 'critical')),
    CONSTRAINT ck_tasks_priority_score CHECK (priority_score BETWEEN 1 AND 10),
    CONSTRAINT ck_tasks_retry_count CHECK (retry_count >= 0),
    CONSTRAINT ck_tasks_max_retries CHECK (max_retries >= 0),
    CONSTRAINT ck_tasks_confidence_score CHECK (confidence_score BETWEEN 0.0 AND 1.0),
    CONSTRAINT ck_tasks_execution_time CHECK (execution_time >= 0),
    CONSTRAINT ck_tasks_depends_structure CHECK (jsonb_typeof(depends_on) = 'array'),
    
    -- å¤–é”®
    CONSTRAINT fk_tasks_assigned_agent FOREIGN KEY (assigned_agent) REFERENCES agents(agent_id),
    CONSTRAINT fk_tasks_assigned_by FOREIGN KEY (assigned_by) REFERENCES users(user_id),
    CONSTRAINT fk_tasks_created_by FOREIGN KEY (created_by) REFERENCES users(user_id),
    CONSTRAINT fk_tasks_parent_task FOREIGN KEY (parent_task_id) REFERENCES tasks(task_id)
);

-- ä¸»è¦ç´¢å¼•
CREATE INDEX idx_tasks_status ON tasks(status);
CREATE INDEX idx_tasks_priority ON tasks(priority, priority_score);
CREATE INDEX idx_tasks_assigned_agent ON tasks(assigned_agent);
CREATE INDEX idx_tasks_task_type ON tasks(task_type);
CREATE INDEX idx_tasks_created_at ON tasks(created_at);
CREATE INDEX idx_tasks_scheduled_at ON tasks(scheduled_at);
CREATE INDEX idx_tasks_deadline ON tasks(deadline);
CREATE INDEX idx_tasks_parent_task ON tasks(parent_task_id);

-- å¤åˆç´¢å¼•
CREATE INDEX idx_tasks_queue ON tasks(status, priority_score, created_at) 
    WHERE status IN ('pending', 'queued');
CREATE INDEX idx_tasks_agent_active ON tasks(assigned_agent, status, assigned_at)
    WHERE status IN ('assigned', 'running');
CREATE INDEX idx_tasks_completion ON tasks(status, completed_at)
    WHERE status IN ('completed', 'failed');

-- GINç´¢å¼•
CREATE INDEX idx_tasks_input_data_gin ON tasks USING GIN (input_data);
CREATE INDEX idx_tasks_depends_on_gin ON tasks USING GIN (depends_on);

-- åˆ†åŒºç´¢å¼•(æŒ‰åˆ›å»ºæ—¶é—´)
CREATE INDEX idx_tasks_created_at_status ON tasks(created_at, status);

-- è§¦å‘å™¨
CREATE TRIGGER trigger_tasks_updated_at
    BEFORE UPDATE ON tasks
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();

-- çŠ¶æ€å˜æ›´è®°å½•è§¦å‘å™¨
CREATE OR REPLACE FUNCTION record_task_status_change()
RETURNS TRIGGER AS $$
BEGIN
    IF OLD.status IS DISTINCT FROM NEW.status THEN
        NEW.previous_status = OLD.status;
        NEW.status_changed_at = CURRENT_TIMESTAMP;
        
        -- è®°å½•çŠ¶æ€å˜æ›´å†å²
        INSERT INTO task_status_history (
            task_id, old_status, new_status, changed_at, changed_by
        ) VALUES (
            NEW.task_id, OLD.status, NEW.status, CURRENT_TIMESTAMP, NEW.updated_by
        );
    END IF;
    
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trigger_tasks_status_change
    BEFORE UPDATE ON tasks
    FOR EACH ROW
    EXECUTE FUNCTION record_task_status_change();

-- æ³¨é‡Š
COMMENT ON TABLE tasks IS 'ä»»åŠ¡ä¸»è¡¨ï¼Œå­˜å‚¨æ‰€æœ‰ä»»åŠ¡ä¿¡æ¯';
COMMENT ON COLUMN tasks.input_data IS 'ä»»åŠ¡è¾“å…¥æ•°æ®ï¼ŒJSONæ ¼å¼';
COMMENT ON COLUMN tasks.depends_on IS 'ä¾èµ–çš„ä»»åŠ¡IDåˆ—è¡¨ï¼ŒJSONæ•°ç»„æ ¼å¼';
COMMENT ON COLUMN tasks.confidence_score IS 'ä»»åŠ¡å®Œæˆç½®ä¿¡åº¦ï¼Œ0.0-1.0';
```

#### 2.3.2 ä»»åŠ¡æ‰§è¡Œè®°å½•è¡¨ (task_executions)

```sql
-- ä»»åŠ¡æ‰§è¡Œè®°å½•è¡¨(æŒ‰æœˆåˆ†åŒº)
CREATE TABLE task_executions (
    -- ä¸»é”®
    execution_id UUID DEFAULT uuid_generate_v4(),
    task_id UUID NOT NULL,
    agent_id UUID NOT NULL,
    
    -- æ‰§è¡Œä¿¡æ¯
    execution_sequence INTEGER NOT NULL DEFAULT 1,
    started_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    completed_at TIMESTAMP,
    execution_time DECIMAL(10,3),
    
    -- çŠ¶æ€ä¿¡æ¯
    status VARCHAR(20) NOT NULL DEFAULT 'running',
    result_status VARCHAR(20),
    error_message TEXT,
    error_stack_trace TEXT,
    
    -- èµ„æºä½¿ç”¨
    memory_usage_mb INTEGER,
    cpu_usage_percent DECIMAL(5,2),
    
    -- æ€§èƒ½æŒ‡æ ‡
    input_tokens INTEGER,
    output_tokens INTEGER,
    api_calls_count INTEGER DEFAULT 0,
    
    -- ç»“æœæ•°æ®
    output_data JSONB,
    metadata JSONB DEFAULT '{}',
    
    -- å®¡è®¡å­—æ®µ(ç®€åŒ–)
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    
    -- ä¸»é”®çº¦æŸ(åŒ…å«åˆ†åŒºé”®)
    PRIMARY KEY (execution_id, created_at),
    
    -- å¤–é”®çº¦æŸ
    CONSTRAINT fk_task_executions_task FOREIGN KEY (task_id) REFERENCES tasks(task_id),
    CONSTRAINT fk_task_executions_agent FOREIGN KEY (agent_id) REFERENCES agents(agent_id),
    
    -- æ£€æŸ¥çº¦æŸ
    CONSTRAINT ck_task_executions_status CHECK (status IN (
        'running', 'completed', 'failed', 'timeout', 'cancelled'
    )),
    CONSTRAINT ck_task_executions_execution_time CHECK (execution_time >= 0),
    CONSTRAINT ck_task_executions_memory CHECK (memory_usage_mb >= 0),
    CONSTRAINT ck_task_executions_cpu CHECK (cpu_usage_percent >= 0 AND cpu_usage_percent <= 100),
    CONSTRAINT ck_task_executions_sequence CHECK (execution_sequence > 0)
    
) PARTITION BY RANGE (created_at);

-- åˆ›å»ºåˆ†åŒºè¡¨(ç¤ºä¾‹ï¼š2024å¹´å„æœˆ)
CREATE TABLE task_executions_2024_01 PARTITION OF task_executions
    FOR VALUES FROM ('2024-01-01') TO ('2024-02-01');
CREATE TABLE task_executions_2024_02 PARTITION OF task_executions
    FOR VALUES FROM ('2024-02-01') TO ('2024-03-01');
-- ... å…¶ä»–æœˆä»½åˆ†åŒº

-- åˆ†åŒºè¡¨ç´¢å¼•
CREATE INDEX idx_task_executions_2024_01_task_id ON task_executions_2024_01(task_id);
CREATE INDEX idx_task_executions_2024_01_agent_id ON task_executions_2024_01(agent_id);
CREATE INDEX idx_task_executions_2024_01_status ON task_executions_2024_01(status);

-- å…¨å±€ç´¢å¼•
CREATE INDEX idx_task_executions_task_id ON task_executions(task_id, created_at);
CREATE INDEX idx_task_executions_agent_id ON task_executions(agent_id, created_at);
CREATE INDEX idx_task_executions_status ON task_executions(status, created_at);

-- è‡ªåŠ¨åˆ›å»ºåˆ†åŒºå‡½æ•°
CREATE OR REPLACE FUNCTION create_task_execution_partition(start_date DATE)
RETURNS void AS $$
DECLARE
    partition_name TEXT;
    end_date DATE;
BEGIN
    partition_name := 'task_executions_' || to_char(start_date, 'YYYY_MM');
    end_date := start_date + INTERVAL '1 month';
    
    EXECUTE format('CREATE TABLE %I PARTITION OF task_executions FOR VALUES FROM (%L) TO (%L)',
                   partition_name, start_date, end_date);
    
    -- åˆ›å»ºåˆ†åŒºè¡¨ç´¢å¼•
    EXECUTE format('CREATE INDEX %I ON %I (task_id)', 
                   'idx_' || partition_name || '_task_id', partition_name);
    EXECUTE format('CREATE INDEX %I ON %I (agent_id)', 
                   'idx_' || partition_name || '_agent_id', partition_name);
    EXECUTE format('CREATE INDEX %I ON %I (status)', 
                   'idx_' || partition_name || '_status', partition_name);
END;
$$ LANGUAGE plpgsql;

-- æ³¨é‡Š
COMMENT ON TABLE task_executions IS 'ä»»åŠ¡æ‰§è¡Œè®°å½•è¡¨ï¼ŒæŒ‰æœˆåˆ†åŒºå­˜å‚¨';
COMMENT ON COLUMN task_executions.execution_sequence IS 'åŒä¸€ä»»åŠ¡çš„æ‰§è¡Œåºå·ï¼Œæ”¯æŒé‡è¯•';
```

### 2.4 Promptç®¡ç†åŸŸè¡¨ç»“æ„

#### 2.4.1 Promptæ¨¡æ¿è¡¨ (prompt_templates)

```sql
-- Promptæ¨¡æ¿ä¸»è¡¨
CREATE TABLE prompt_templates (
    -- ä¸»é”®
    template_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    
    -- åŸºç¡€ä¿¡æ¯
    template_name VARCHAR(100) NOT NULL,
    template_type VARCHAR(50) NOT NULL,
    agent_type VARCHAR(50),
    task_type VARCHAR(50),
    
    -- ç‰ˆæœ¬ä¿¡æ¯
    version VARCHAR(20) NOT NULL DEFAULT '1.0.0',
    is_active BOOLEAN NOT NULL DEFAULT true,
    is_published BOOLEAN NOT NULL DEFAULT false,
    
    -- æ¨¡æ¿å†…å®¹
    template_content TEXT NOT NULL,
    template_variables JSONB DEFAULT '{}',
    validation_rules JSONB DEFAULT '{}',
    
    -- åˆ†ç±»æ ‡ç­¾
    category VARCHAR(50),
    tags JSONB DEFAULT '[]',
    
    -- ä½¿ç”¨ç»Ÿè®¡
    usage_count INTEGER NOT NULL DEFAULT 0,
    success_rate DECIMAL(5,2) DEFAULT 0,
    average_rating DECIMAL(3,2) DEFAULT 0,
    
    -- é…ç½®ä¿¡æ¯
    max_tokens INTEGER,
    temperature DECIMAL(3,2),
    top_p DECIMAL(3,2),
    
    -- å®¡è®¡å­—æ®µ
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    created_by UUID NOT NULL,
    updated_by UUID,
    published_at TIMESTAMP,
    published_by UUID,
    
    -- è½¯åˆ é™¤
    deleted_at TIMESTAMP,
    deleted_by UUID,
    
    -- çº¦æŸ
    CONSTRAINT ck_prompt_templates_version CHECK (version ~ '^[0-9]+\.[0-9]+\.[0-9]+'),
    CONSTRAINT ck_prompt_templates_success_rate CHECK (success_rate >= 0 AND success_rate <= 100),
    CONSTRAINT ck_prompt_templates_rating CHECK (average_rating >= 0 AND average_rating <= 5),
    CONSTRAINT ck_prompt_templates_temperature CHECK (temperature >= 0 AND temperature <= 2),
    CONSTRAINT ck_prompt_templates_top_p CHECK (top_p >= 0 AND top_p <= 1),
    CONSTRAINT ck_prompt_templates_variables_structure CHECK (jsonb_typeof(template_variables) = 'object'),
    CONSTRAINT ck_prompt_templates_tags_structure CHECK (jsonb_typeof(tags) = 'array'),
    
    -- å¤–é”®
    CONSTRAINT fk_prompt_templates_created_by FOREIGN KEY (created_by) REFERENCES users(user_id),
    CONSTRAINT fk_prompt_templates_published_by FOREIGN KEY (published_by) REFERENCES users(user_id),
    
    -- å”¯ä¸€çº¦æŸ
    CONSTRAINT uk_prompt_templates_name_version UNIQUE (template_name, version, deleted_at)
);

-- ç´¢å¼•
CREATE INDEX idx_prompt_templates_name ON prompt_templates(template_name);
CREATE INDEX idx_prompt_templates_type ON prompt_templates(template_type);
CREATE INDEX idx_prompt_templates_agent_type ON prompt_templates(agent_type);
CREATE INDEX idx_prompt_templates_task_type ON prompt_templates(task_type);
CREATE INDEX idx_prompt_templates_category ON prompt_templates(category);
CREATE INDEX idx_prompt_templates_active ON prompt_templates(is_active, is_published);
CREATE INDEX idx_prompt_templates_usage ON prompt_templates(usage_count DESC);
CREATE INDEX idx_prompt_templates_rating ON prompt_templates(average_rating DESC);

-- GINç´¢å¼•
CREATE INDEX idx_prompt_templates_tags_gin ON prompt_templates USING GIN (tags);
CREATE INDEX idx_prompt_templates_variables_gin ON prompt_templates USING GIN (template_variables);

-- å…¨æ–‡æœç´¢ç´¢å¼•
CREATE INDEX idx_prompt_templates_content_fts ON prompt_templates 
    USING GIN (to_tsvector('english', template_content));

-- å¤åˆç´¢å¼•
CREATE INDEX idx_prompt_templates_agent_task ON prompt_templates(agent_type, task_type, is_active);

-- è§¦å‘å™¨
CREATE TRIGGER trigger_prompt_templates_updated_at
    BEFORE UPDATE ON prompt_templates
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();

-- æ³¨é‡Š
COMMENT ON TABLE prompt_templates IS 'Promptæ¨¡æ¿ç®¡ç†è¡¨';
COMMENT ON COLUMN prompt_templates.template_variables IS 'æ¨¡æ¿å˜é‡å®šä¹‰ï¼ŒJSONæ ¼å¼';
COMMENT ON COLUMN prompt_templates.validation_rules IS 'æ¨¡æ¿éªŒè¯è§„åˆ™ï¼ŒJSONæ ¼å¼';
COMMENT ON COLUMN prompt_templates.usage_count IS 'æ¨¡æ¿ä½¿ç”¨æ¬¡æ•°ç»Ÿè®¡';
```

#### 2.4.2 Promptä½¿ç”¨è®°å½•è¡¨ (prompt_usage_logs)

```sql
-- Promptä½¿ç”¨è®°å½•è¡¨(æŒ‰æ—¥åˆ†åŒº)
CREATE TABLE prompt_usage_logs (
    -- ä¸»é”®
    usage_id UUID DEFAULT uuid_generate_v4(),
    template_id UUID NOT NULL,
    
    -- ä½¿ç”¨ä¿¡æ¯
    agent_id UUID,
    task_id UUID,
    user_id UUID,
    
    -- æ‰§è¡Œä¿¡æ¯
    rendered_prompt TEXT,
    input_variables JSONB,
    execution_result VARCHAR(20),
    response_time DECIMAL(10,3),
    
    -- è´¨é‡è¯„ä¼°
    success BOOLEAN,
    rating INTEGER,  -- 1-5æ˜Ÿè¯„åˆ†
    feedback TEXT,
    
    -- èµ„æºæ¶ˆè€—
    input_tokens INTEGER,
    output_tokens INTEGER,
    total_cost DECIMAL(10,4),
    
    -- å®¡è®¡å­—æ®µ
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    
    -- ä¸»é”®(åŒ…å«åˆ†åŒºé”®)
    PRIMARY KEY (usage_id, created_at),
    
    -- å¤–é”®çº¦æŸ
    CONSTRAINT fk_prompt_usage_template FOREIGN KEY (template_id) REFERENCES prompt_templates(template_id),
    CONSTRAINT fk_prompt_usage_agent FOREIGN KEY (agent_id) REFERENCES agents(agent_id),
    CONSTRAINT fk_prompt_usage_task FOREIGN KEY (task_id) REFERENCES tasks(task_id),
    CONSTRAINT fk_prompt_usage_user FOREIGN KEY (user_id) REFERENCES users(user_id),
    
    -- æ£€æŸ¥çº¦æŸ
    CONSTRAINT ck_prompt_usage_rating CHECK (rating >= 1 AND rating <= 5),
    CONSTRAINT ck_prompt_usage_response_time CHECK (response_time >= 0),
    CONSTRAINT ck_prompt_usage_tokens CHECK (input_tokens >= 0 AND output_tokens >= 0),
    CONSTRAINT ck_prompt_usage_cost CHECK (total_cost >= 0)
    
) PARTITION BY RANGE (created_at);

-- åˆ›å»ºæ—¥åˆ†åŒºè¡¨
CREATE TABLE prompt_usage_logs_2024_01_24 PARTITION OF prompt_usage_logs
    FOR VALUES FROM ('2024-01-24') TO ('2024-01-25');

-- åˆ†åŒºç´¢å¼•
CREATE INDEX idx_prompt_usage_logs_template_id ON prompt_usage_logs(template_id, created_at);
CREATE INDEX idx_prompt_usage_logs_agent_id ON prompt_usage_logs(agent_id, created_at);
CREATE INDEX idx_prompt_usage_logs_success ON prompt_usage_logs(success, created_at);

-- æ³¨é‡Š
COMMENT ON TABLE prompt_usage_logs IS 'Promptä½¿ç”¨è®°å½•è¡¨ï¼ŒæŒ‰æ—¥åˆ†åŒºå­˜å‚¨';
```

---

## ğŸ”§ è¾…åŠ©è¡¨å’Œç³»ç»Ÿè¡¨è®¾è®¡

### 3.1 ç³»ç»Ÿé…ç½®è¡¨

#### 3.1.1 ç³»ç»Ÿé…ç½®è¡¨ (system_configs)

```sql
-- ç³»ç»Ÿé…ç½®è¡¨
CREATE TABLE system_configs (
    -- ä¸»é”®
    config_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    
    -- é…ç½®ä¿¡æ¯
    config_key VARCHAR(100) UNIQUE NOT NULL,
    config_value TEXT,
    config_type VARCHAR(20) NOT NULL DEFAULT 'string',
    
    -- åˆ†ç»„å’Œæè¿°
    config_group VARCHAR(50),
    description TEXT,
    
    -- é…ç½®å±æ€§
    is_encrypted BOOLEAN NOT NULL DEFAULT false,
    is_system_config BOOLEAN NOT NULL DEFAULT false,
    requires_restart BOOLEAN NOT NULL DEFAULT false,
    
    -- éªŒè¯è§„åˆ™
    validation_regex VARCHAR(500),
    allowed_values JSONB,
    
    -- å®¡è®¡å­—æ®µ
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    created_by UUID NOT NULL,
    updated_by UUID,
    
    -- çº¦æŸ
    CONSTRAINT ck_system_configs_type CHECK (config_type IN ('string', 'integer', 'boolean', 'json', 'decimal')),
    CONSTRAINT ck_system_configs_key_format CHECK (config_key ~ '^[a-z0-9_\.]+$'),
    CONSTRAINT fk_system_configs_created_by FOREIGN KEY (created_by) REFERENCES users(user_id)
);

-- ç´¢å¼•
CREATE INDEX idx_system_configs_group ON system_configs(config_group);
CREATE INDEX idx_system_configs_system ON system_configs(is_system_config);

-- æ³¨é‡Š
COMMENT ON TABLE system_configs IS 'ç³»ç»Ÿé…ç½®è¡¨';
COMMENT ON COLUMN system_configs.is_encrypted IS 'é…ç½®å€¼æ˜¯å¦åŠ å¯†å­˜å‚¨';
```

#### 3.1.2 æ•°æ®å­—å…¸è¡¨ (data_dictionaries)

```sql
-- æ•°æ®å­—å…¸è¡¨
CREATE TABLE data_dictionaries (
    -- ä¸»é”®
    dict_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    
    -- å­—å…¸ä¿¡æ¯
    dict_type VARCHAR(50) NOT NULL,
    dict_code VARCHAR(50) NOT NULL,
    dict_value VARCHAR(200) NOT NULL,
    
    -- å±‚çº§å…³ç³»
    parent_code VARCHAR(50),
    level_num INTEGER NOT NULL DEFAULT 1,
    sort_order INTEGER NOT NULL DEFAULT 0,
    
    -- çŠ¶æ€ä¿¡æ¯
    is_active BOOLEAN NOT NULL DEFAULT true,
    
    -- æ‰©å±•ä¿¡æ¯
    description TEXT,
    extra_data JSONB DEFAULT '{}',
    
    -- å®¡è®¡å­—æ®µ
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    created_by UUID NOT NULL,
    updated_by UUID,
    
    -- çº¦æŸ
    CONSTRAINT uk_data_dictionaries_type_code UNIQUE (dict_type, dict_code),
    CONSTRAINT ck_data_dictionaries_level CHECK (level_num > 0),
    CONSTRAINT fk_data_dictionaries_created_by FOREIGN KEY (created_by) REFERENCES users(user_id)
);

-- ç´¢å¼•
CREATE INDEX idx_data_dictionaries_type ON data_dictionaries(dict_type);
CREATE INDEX idx_data_dictionaries_parent ON data_dictionaries(parent_code);
CREATE INDEX idx_data_dictionaries_active ON data_dictionaries(is_active);
CREATE INDEX idx_data_dictionaries_sort ON data_dictionaries(dict_type, sort_order);

-- æ³¨é‡Š
COMMENT ON TABLE data_dictionaries IS 'æ•°æ®å­—å…¸è¡¨ï¼Œå­˜å‚¨ç³»ç»Ÿæšä¸¾å€¼';
```

### 3.2 æ—¥å¿—å’Œå®¡è®¡è¡¨

#### 3.2.1 ç³»ç»Ÿæ—¥å¿—è¡¨ (system_logs)

```sql
-- ç³»ç»Ÿæ—¥å¿—è¡¨(æŒ‰æ—¥åˆ†åŒº)
CREATE TABLE system_logs (
    -- ä¸»é”®
    log_id UUID DEFAULT uuid_generate_v4(),
    
    -- æ—¥å¿—ä¿¡æ¯
    log_level VARCHAR(10) NOT NULL,
    logger_name VARCHAR(100) NOT NULL,
    message TEXT NOT NULL,
    
    -- ä¸Šä¸‹æ–‡ä¿¡æ¯
    module_name VARCHAR(50),
    function_name VARCHAR(100),
    line_number INTEGER,
    
    -- è¯·æ±‚ä¿¡æ¯
    request_id VARCHAR(50),
    user_id UUID,
    session_id VARCHAR(100),
    ip_address INET,
    user_agent TEXT,
    
    -- å¼‚å¸¸ä¿¡æ¯
    exception_type VARCHAR(100),
    stack_trace TEXT,
    
    -- æ—¶é—´ä¿¡æ¯
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    
    -- ä¸»é”®(åŒ…å«åˆ†åŒºé”®)
    PRIMARY KEY (log_id, created_at),
    
    -- çº¦æŸ
    CONSTRAINT ck_system_logs_level CHECK (log_level IN ('DEBUG', 'INFO', 'WARN', 'ERROR', 'FATAL')),
    CONSTRAINT fk_system_logs_user FOREIGN KEY (user_id) REFERENCES users(user_id)
    
) PARTITION BY RANGE (created_at);

-- åˆ†åŒºç´¢å¼•
CREATE INDEX idx_system_logs_level ON system_logs(log_level, created_at);
CREATE INDEX idx_system_logs_module ON system_logs(module_name, created_at);
CREATE INDEX idx_system_logs_user ON system_logs(user_id, created_at);
CREATE INDEX idx_system_logs_request ON system_logs(request_id, created_at);

-- å…¨æ–‡æœç´¢ç´¢å¼•
CREATE INDEX idx_system_logs_message_fts ON system_logs 
    USING GIN (to_tsvector('english', message));

-- æ³¨é‡Š
COMMENT ON TABLE system_logs IS 'ç³»ç»Ÿæ—¥å¿—è¡¨ï¼ŒæŒ‰æ—¥åˆ†åŒºå­˜å‚¨';
```

#### 3.2.2 æ“ä½œå®¡è®¡è¡¨ (audit_logs)

```sql
-- æ“ä½œå®¡è®¡è¡¨(æŒ‰æœˆåˆ†åŒº)  
CREATE TABLE audit_logs (
    -- ä¸»é”®
    audit_id UUID DEFAULT uuid_generate_v4(),
    
    -- å®¡è®¡ä¿¡æ¯
    table_name VARCHAR(50) NOT NULL,
    record_id UUID NOT NULL,
    operation VARCHAR(10) NOT NULL,
    
    -- å˜æ›´æ•°æ®
    old_values JSONB,
    new_values JSONB,
    changed_fields JSONB,
    
    -- æ“ä½œè€…ä¿¡æ¯
    user_id UUID,
    username VARCHAR(50),
    ip_address INET,
    user_agent TEXT,
    
    -- æ—¶é—´ä¿¡æ¯
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    
    -- ä¸»é”®(åŒ…å«åˆ†åŒºé”®)
    PRIMARY KEY (audit_id, created_at),
    
    -- çº¦æŸ
    CONSTRAINT ck_audit_logs_operation CHECK (operation IN ('INSERT', 'UPDATE', 'DELETE')),
    CONSTRAINT fk_audit_logs_user FOREIGN KEY (user_id) REFERENCES users(user_id)
    
) PARTITION BY RANGE (created_at);

-- åˆ†åŒºç´¢å¼•
CREATE INDEX idx_audit_logs_table_record ON audit_logs(table_name, record_id, created_at);
CREATE INDEX idx_audit_logs_user ON audit_logs(user_id, created_at);
CREATE INDEX idx_audit_logs_operation ON audit_logs(operation, created_at);

-- æ³¨é‡Š
COMMENT ON TABLE audit_logs IS 'æ“ä½œå®¡è®¡è¡¨ï¼Œè®°å½•æ•°æ®å˜æ›´å†å²';
```

---

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–è¡¨è®¾è®¡

### 4.1 ç»Ÿè®¡æ±‡æ€»è¡¨

#### 4.1.1 Agentæ€§èƒ½æ±‡æ€»è¡¨ (agent_performance_summary)

```sql
-- Agentæ€§èƒ½æ±‡æ€»è¡¨(ç‰©åŒ–è§†å›¾)
CREATE TABLE agent_performance_summary (
    -- ä¸»é”®  
    agent_id UUID PRIMARY KEY,
    
    -- åŸºç¡€ä¿¡æ¯(å†—ä½™å­˜å‚¨)
    agent_type VARCHAR(50) NOT NULL,
    agent_name VARCHAR(100) NOT NULL,
    
    -- ç»Ÿè®¡æ—¶é—´èŒƒå›´
    stats_date DATE NOT NULL DEFAULT CURRENT_DATE,
    last_updated TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    
    -- ä»»åŠ¡ç»Ÿè®¡
    total_tasks INTEGER NOT NULL DEFAULT 0,
    completed_tasks INTEGER NOT NULL DEFAULT 0,
    failed_tasks INTEGER NOT NULL DEFAULT 0,
    cancelled_tasks INTEGER NOT NULL DEFAULT 0,
    
    -- æ€§èƒ½æŒ‡æ ‡
    success_rate DECIMAL(5,2) NOT NULL DEFAULT 0,
    average_execution_time DECIMAL(10,3) NOT NULL DEFAULT 0,
    median_execution_time DECIMAL(10,3) NOT NULL DEFAULT 0,
    p95_execution_time DECIMAL(10,3) NOT NULL DEFAULT 0,
    
    -- èµ„æºä½¿ç”¨
    average_memory_usage DECIMAL(10,2) NOT NULL DEFAULT 0,
    average_cpu_usage DECIMAL(5,2) NOT NULL DEFAULT 0,
    peak_memory_usage DECIMAL(10,2) NOT NULL DEFAULT 0,
    peak_cpu_usage DECIMAL(5,2) NOT NULL DEFAULT 0,
    
    -- è´¨é‡æŒ‡æ ‡
    average_confidence_score DECIMAL(3,2) NOT NULL DEFAULT 0,
    total_prompt_tokens BIGINT NOT NULL DEFAULT 0,
    total_completion_tokens BIGINT NOT NULL DEFAULT 0,
    total_cost DECIMAL(12,4) NOT NULL DEFAULT 0,
    
    -- å¤–é”®çº¦æŸ
    CONSTRAINT fk_agent_performance_agent FOREIGN KEY (agent_id) REFERENCES agents(agent_id) ON DELETE CASCADE
);

-- ç´¢å¼•
CREATE INDEX idx_agent_performance_stats_date ON agent_performance_summary(stats_date);
CREATE INDEX idx_agent_performance_success_rate ON agent_performance_summary(success_rate DESC);
CREATE INDEX idx_agent_performance_avg_time ON agent_performance_summary(average_execution_time);
CREATE INDEX idx_agent_performance_type ON agent_performance_summary(agent_type, success_rate DESC);

-- è‡ªåŠ¨æ›´æ–°è§¦å‘å™¨
CREATE OR REPLACE FUNCTION refresh_agent_performance_summary()
RETURNS void AS $$
BEGIN
    INSERT INTO agent_performance_summary (
        agent_id, agent_type, agent_name, stats_date,
        total_tasks, completed_tasks, failed_tasks,
        success_rate, average_execution_time,
        average_memory_usage, average_cpu_usage
    )
    SELECT 
        a.agent_id,
        a.agent_type,
        a.agent_name,
        CURRENT_DATE,
        COUNT(t.task_id),
        COUNT(CASE WHEN t.status = 'completed' THEN 1 END),
        COUNT(CASE WHEN t.status = 'failed' THEN 1 END),
        ROUND(
            COUNT(CASE WHEN t.status = 'completed' THEN 1 END) * 100.0 / 
            NULLIF(COUNT(t.task_id), 0), 2
        ),
        ROUND(AVG(te.execution_time), 3),
        ROUND(AVG(te.memory_usage_mb), 2),
        ROUND(AVG(te.cpu_usage_percent), 2)
    FROM agents a
    LEFT JOIN tasks t ON a.agent_id = t.assigned_agent 
        AND t.created_at >= CURRENT_DATE
    LEFT JOIN task_executions te ON t.task_id = te.task_id
    WHERE a.deleted_at IS NULL
    GROUP BY a.agent_id, a.agent_type, a.agent_name
    ON CONFLICT (agent_id) DO UPDATE SET
        total_tasks = EXCLUDED.total_tasks,
        completed_tasks = EXCLUDED.completed_tasks,
        failed_tasks = EXCLUDED.failed_tasks,
        success_rate = EXCLUDED.success_rate,
        average_execution_time = EXCLUDED.average_execution_time,
        average_memory_usage = EXCLUDED.average_memory_usage,
        average_cpu_usage = EXCLUDED.average_cpu_usage,
        last_updated = CURRENT_TIMESTAMP;
END;
$$ LANGUAGE plpgsql;

-- æ³¨é‡Š
COMMENT ON TABLE agent_performance_summary IS 'Agentæ€§èƒ½æ±‡æ€»è¡¨ï¼Œæ¯æ—¥æ›´æ–°ç»Ÿè®¡æ•°æ®';
```

### 4.2 ç¼“å­˜è¡¨è®¾è®¡

#### 4.2.1 çƒ­ç‚¹æ•°æ®ç¼“å­˜è¡¨

```sql
-- çƒ­ç‚¹æŸ¥è¯¢ç¼“å­˜è¡¨
CREATE TABLE cache_entries (
    -- ä¸»é”®
    cache_key VARCHAR(255) PRIMARY KEY,
    
    -- ç¼“å­˜æ•°æ®
    cache_value JSONB NOT NULL,
    cache_type VARCHAR(50) NOT NULL,
    
    -- ç¼“å­˜å…ƒæ•°æ®
    ttl_seconds INTEGER NOT NULL DEFAULT 3600,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    accessed_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    access_count INTEGER NOT NULL DEFAULT 0,
    
    -- è‡ªåŠ¨è¿‡æœŸ
    expires_at TIMESTAMP NOT NULL DEFAULT (CURRENT_TIMESTAMP + INTERVAL '1 hour'),
    
    -- çº¦æŸ
    CONSTRAINT ck_cache_entries_ttl CHECK (ttl_seconds > 0)
);

-- ç´¢å¼•
CREATE INDEX idx_cache_entries_expires_at ON cache_entries(expires_at);
CREATE INDEX idx_cache_entries_type ON cache_entries(cache_type);
CREATE INDEX idx_cache_entries_accessed_at ON cache_entries(accessed_at);

-- è‡ªåŠ¨æ¸…ç†è¿‡æœŸç¼“å­˜
CREATE OR REPLACE FUNCTION cleanup_expired_cache()
RETURNS INTEGER AS $$
DECLARE
    deleted_count INTEGER;
BEGIN
    DELETE FROM cache_entries WHERE expires_at < CURRENT_TIMESTAMP;
    GET DIAGNOSTICS deleted_count = ROW_COUNT;
    RETURN deleted_count;
END;
$$ LANGUAGE plpgsql;

-- æ³¨é‡Š
COMMENT ON TABLE cache_entries IS 'åº”ç”¨çº§ç¼“å­˜è¡¨ï¼Œå­˜å‚¨çƒ­ç‚¹æŸ¥è¯¢ç»“æœ';
```

---

## ğŸ“‹ è¡¨ç»“æ„æ£€æŸ¥æ¸…å•

### 5.1 è®¾è®¡æ£€æŸ¥æ¸…å•

#### 5.1.1 åŸºç¡€ç»“æ„æ£€æŸ¥
- [ ] **ä¸»é”®è®¾è®¡**
  - [ ] ä½¿ç”¨UUIDä½œä¸ºä¸»é”®
  - [ ] ä¸»é”®å­—æ®µå‘½åä¸º{table}_id
  - [ ] ä¸»é”®è®¾ç½®DEFAULT uuid_generate_v4()

- [ ] **å¿…éœ€å­—æ®µæ£€æŸ¥**
  - [ ] created_atå­—æ®µå·²æ·»åŠ 
  - [ ] updated_atå­—æ®µå·²æ·»åŠ   
  - [ ] created_byå­—æ®µå·²æ·»åŠ 
  - [ ] ç›¸å…³è§¦å‘å™¨å·²åˆ›å»º

- [ ] **çº¦æŸæ£€æŸ¥**
  - [ ] NOT NULLçº¦æŸæ­£ç¡®è®¾ç½®
  - [ ] CHECKçº¦æŸé€»è¾‘æ­£ç¡®
  - [ ] å¤–é”®çº¦æŸå·²å»ºç«‹
  - [ ] å”¯ä¸€çº¦æŸåˆç†è®¾ç½®

#### 5.1.2 æ€§èƒ½ä¼˜åŒ–æ£€æŸ¥
- [ ] **ç´¢å¼•è®¾è®¡**
  - [ ] ä¸»è¦æŸ¥è¯¢å­—æ®µå·²å»ºç´¢å¼•
  - [ ] å¤–é”®å­—æ®µå·²å»ºç´¢å¼•
  - [ ] å¤åˆç´¢å¼•é¡ºåºåˆç†
  - [ ] JSONBå­—æ®µä½¿ç”¨GINç´¢å¼•

- [ ] **åˆ†åŒºè®¾è®¡**
  - [ ] å¤§è¡¨è€ƒè™‘åˆ†åŒºç­–ç•¥
  - [ ] åˆ†åŒºé”®é€‰æ‹©åˆç†
  - [ ] åˆ†åŒºè¡¨ç´¢å¼•å·²åˆ›å»º

#### 5.1.3 å®‰å…¨æ€§æ£€æŸ¥
- [ ] **æ•æ„Ÿæ•°æ®å¤„ç†**
  - [ ] å¯†ç å­—æ®µä½¿ç”¨å“ˆå¸Œå­˜å‚¨
  - [ ] æ•æ„Ÿä¿¡æ¯è€ƒè™‘åŠ å¯†
  - [ ] PIIæ•°æ®æ ‡è¯†æ¸…æ™°

- [ ] **å®¡è®¡è®¾è®¡**
  - [ ] å…³é”®è¡¨å¯ç”¨å®¡è®¡
  - [ ] å®¡è®¡è§¦å‘å™¨æ­£ç¡®é…ç½®
  - [ ] è½¯åˆ é™¤æœºåˆ¶å®Œæ•´

### 5.2 ä»£ç ç”Ÿæˆæ¨¡æ¿

#### 5.2.1 æ ‡å‡†è¡¨åˆ›å»ºæ¨¡æ¿

```sql
-- è¡¨åˆ›å»ºæ¨¡æ¿
-- è¡¨å: {table_name}
-- æè¿°: {table_description}
-- åˆ›å»ºæ—¥æœŸ: {creation_date}

CREATE TABLE {table_name} (
    -- ä¸»é”®
    {table_name}_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    
    -- ä¸šåŠ¡å­—æ®µ
    {business_fields}
    
    -- çŠ¶æ€å­—æ®µ(å¯é€‰)
    status VARCHAR(20) NOT NULL DEFAULT 'active',
    
    -- å®¡è®¡å­—æ®µ
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    created_by UUID NOT NULL,
    updated_by UUID,
    
    -- è½¯åˆ é™¤(å¯é€‰)
    deleted_at TIMESTAMP,
    deleted_by UUID,
    
    -- çº¦æŸ
    {constraints}
    
    -- å¤–é”®
    {foreign_keys}
);

-- ç´¢å¼•
{indexes}

-- è§¦å‘å™¨
CREATE TRIGGER trigger_{table_name}_updated_at
    BEFORE UPDATE ON {table_name}
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();

-- æ³¨é‡Š
COMMENT ON TABLE {table_name} IS '{table_description}';
{column_comments}
```

---

**æ–‡æ¡£çŠ¶æ€**: æ­£å¼å‘å¸ƒ  
**æœ€åæ›´æ–°**: 2024-01-24  
**ä¸‹æ¬¡è¯„å®¡**: 2024-04-24  
**æ‰¹å‡†äºº**: æ•°æ®å»ºæ¨¡å§”å‘˜ä¼š